{% extends "base.html" %}
{% block content %}
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>í˜„ì¥ì‹œí—˜ í†µí•© ê´€ë¦¬ ì‹œìŠ¤í…œ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <script src="https://cdn.jsdelivr.net/npm/ag-grid-community/dist/ag-grid-community.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ag-grid-community/styles/ag-grid.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ag-grid-community/styles/ag-theme-quartz.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <style>
    /* 1. ê¸°ë³¸ ë°°ê²½ ë° ìŠ¤í¬ë¡¤ ë°©ì§€ */
    body, html { 
        height: 100%; 
        margin: 0; 
        padding: 0; 
        overflow: hidden; 
        background-color: #f4f7f6; 
        font-family: 'Pretendard', sans-serif; 
    }
    
    /* 2. ë©”ì¸ ë˜í¼: ë†’ì´ë¥¼ % ê¸°ë°˜ìœ¼ë¡œ ì„¤ì •í•˜ì—¬ í•˜ë‹¨ ì˜ë¦¼ ë°©ì§€ */
    .main-wrapper { 
        position: absolute;
        top: 45px; /* í—¤ë” ë†’ì´ë§Œí¼ ì•„ë˜ë¡œ */
        left: 0;
        right: 0;
        bottom: 0; /* í™”ë©´ ëê¹Œì§€ ê½‰ ì±„ì›€ */
        display: flex; 
        flex-direction: column; 
        padding: 8px; 
        gap: 8px; 
        box-sizing: border-box;
    }
    
    /* 3. í–‰(Row) ì„¤ì •: flex-basisë¥¼ ì‚¬ìš©í•˜ì—¬ ì •í™•í•œ ë“±ë¶„ */
    .top-row { 
        flex: 1 1 50%; /* ìƒë‹¨ ì ˆë°˜ */
        display: flex; 
        gap: 8px; 
        min-height: 0; 
    }
    
    .bottom-row { 
        flex: 1 1 50%; /* í•˜ë‹¨ ì ˆë°˜ */
        display: flex; 
        gap: 8px; 
        min-height: 0;
        padding-bottom: 5px; /* ìµœí•˜ë‹¨ ì„ ì´ ê°€ë ¤ì§€ì§€ ì•Šê²Œ ì•ˆì „ì¥ì¹˜ */
    }
    
    /* 4. ì¹´ë“œ ë° ê·¸ë¦¬ë“œ ê³ ì • */
    .card { 
        height: 100%; 
        display: flex; 
        flex-direction: column; 
        border: 1px solid rgba(0,0,0,0.125); 
        border-radius: 8px; 
        overflow: hidden;
        background: #fff;
    }
    
    .card-header { 
        padding: 4px 12px; 
        font-weight: bold; 
        flex-shrink: 0; 
        font-size: 0.85rem; 
        min-height: 30px;
        display: flex;
        align-items: center;
    } 
    
    .card-body { 
        flex: 1; 
        overflow: hidden; /* ì¤‘ìš”: ë°”ë””ê°€ ë„˜ì¹˜ì§€ ì•Šê²Œ */
        padding: 0; 
        position: relative; 
    }

    #bizmekaGrid { width: 100%; height: 100%; }

    /* AG-Grid ë†’ì´ ìµœì í™” */
    .ag-header { min-height: 35px !important; height: 35px !important; }
    .ag-theme-quartz { --ag-grid-size: 4px; --ag-list-item-height: 25px; } /* í–‰ ê°„ê²© ì¶•ì†Œ */


</style>
</head>
<body>

<div class="d-flex justify-content-between align-items-center px-3 py-1 bg-white border-bottom" style="height: 45px;">
    <h6 class="mb-0 fw-bold text-primary"><i class="fas fa-microscope"></i> í˜„ì¥ì‹œí—˜ ê´€ë¦¬ v2.0</h6>
    <button type="button" 
            class="btn btn-sm btn-outline-secondary me-2 d-flex align-items-center" 
            onclick="location.href='/'" 
            style="cursor: pointer;">
        <i class="fa-solid fa-house me-1"></i> í™ˆ
    </button>
</div>

<div class="main-wrapper">
    <div class="top-row">
        <div style="flex: 4;">
            <div class="card border-primary">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <span class="small"><i class="fas fa-sync-alt"></i> ë¹„ì¦ˆë©”ì¹´</span>
                    <div class="header-controls d-flex gap-1 align-items-center">
                        <select id="search-year" class="form-select form-select-sm py-0" style="width: 85px;">
                            <option value="2025">2025ë…„</option><option value="2026" selected>2026ë…„</option>
                        </select>
                        <select id="search-month" class="form-select form-select-sm py-0" style="width: 65px;">
                            <option value="1">1ì›”</option><option value="2">2ì›”</option>
                        </select>
                        <button onclick="syncBizmeka()" class="btn btn-light btn-sm py-0 fw-bold">ë¶ˆëŸ¬ì˜¤ê¸°</button>                        
                        <div class="vr mx-1" style="height: 20px; color: white;"></div> 
                        <button onclick="deleteSelected()" class="btn btn-danger btn-sm py-0">ì‚­ì œ</button>
                        <button onclick="downloadExcel()" class="btn btn-success btn-sm py-0">ì—‘ì…€ë‹¤ìš´ë¡œë“œ</button>
                        <button onclick="uploadExcel()" class="btn btn-warning btn-sm py-0">ì—‘ì…€ê°€ì ¸ì˜¤ê¸°</button>
                    </div>
                </div>
                <div class="card-body">
                    <div id="bizmekaGrid" class="ag-theme-quartz"></div>
                </div>
            </div>
        </div>

        <div style="flex: 6;">
            <div class="card border-info">
                <div class="card-header bg-info text-white d-flex align-items-center py-1 px-2" style="height: 35px;">
                    <span class="small fw-bold me-auto" style="min-width: 120px;">
                        <i class="fas fa-database"></i> QT DB ì¡°íšŒ
                    </span>

                    <div class="d-flex align-items-center gap-2">
                        <span class="small">ê¸°ê°„:</span>
                        <input type="date" id="db_startDate" class="form-control form-control-sm" style="width: 130px;">
                        <span class="small">~</span>
                        <input type="date" id="db_endDate" class="form-control form-control-sm" style="width: 130px;">

                        <span class="small ms-2">ì‹œê³µì‚¬:</span>
                        <input type="text" id="db_builderSearch" class="form-control form-control-sm" style="width: 150px;" placeholder="ì‹œê³µì‚¬ ì…ë ¥">

                        <button type="button" class="btn btn-warning btn-sm fw-bold px-3" onclick="onDbSearch()" style="cursor: pointer;">
                            <i class="fas fa-search"></i> ì¡°íšŒ
                        </button>
                    </div>
                </div>
                
                <div class="card-body" style="height: 500px; padding: 0; position: relative;">
                    <div id="dbGrid" class="ag-theme-quartz" style="width: 100%; height: 100%;"></div>
                </div>
                
            </div>
        </div>
    </div>

    <div class="bottom-row" style="display: flex; gap: 8px; align-items: stretch;">

    <div style="flex: 5;">
        <div class="card shadow-sm border-secondary border-opacity-25 h-100">
            <div class="card-header bg-light text-secondary py-1 px-2 d-flex justify-content-between align-items-center" style="height: 35px;">
                <span class="small fw-bold"><i class="bi bi-check-circle-fill text-success"></i> ì™„ë£Œê±´ ë³´ê¸°</span>
                
                <div class="d-flex align-items-center gap-1">
                    <select id="finish-year" class="form-select form-select-sm py-0" style="width: 85px; font-size: 0.75rem;">
                        <option value="2023">2023ë…„</option>
                        <option value="2024">2024ë…„</option>
                        <option value="2025">2025ë…„</option>
                        <option value="2026" selected>2026ë…„</option>
                        <option value="2027">2027ë…„</option>
                    </select>

                    <select id="finish-month" class="form-select form-select-sm py-0" style="width: 65px; font-size: 0.75rem;">
                        <option value="all">ì „ì²´</option>
                        <option value="1">1ì›”</option>
                        <option value="2">2ì›”</option>
                        <option value="3">3ì›”</option>
                        <option value="4">4ì›”</option>
                        <option value="5">5ì›”</option>
                        <option value="6">6ì›”</option>
                        <option value="7">7ì›”</option>
                        <option value="8">8ì›”</option>
                        <option value="9">9ì›”</option>
                        <option value="10">10ì›”</option>
                        <option value="11">11ì›”</option>
                        <option value="12">12ì›”</option>
                    </select>

                    <select id="finish-manager" class="form-select form-select-sm py-0" style="width: 90px; font-size: 0.75rem;">
                        <option value="ì „ì²´">ì „ì²´</option>
                        <option value="ìœ„ì¬ì™„">ìœ„ì¬ì™„</option>
                        <option value="ì–‘ì§€í›ˆ">ì–‘ì§€í›ˆ</option>
                        <option value="ê¶Œì„ê·œ">ê¶Œì„ê·œ</option>
                        <option value="ì˜¤ë²”ì„">ì˜¤ë²”ì„</option>
                    </select>

                    <button onclick="loadFinishedData()" class="btn btn-primary btn-sm py-0 fw-bold" style="font-size: 0.75rem;">ë¶ˆëŸ¬ì˜¤ê¸°</button>
                    <button onclick="updateFinishedData()" class="btn btn-info btn-sm py-0 fw-bold text-white" style="font-size: 0.75rem;">
                        <i class="bi bi-pencil-square"></i> DB ìˆ˜ì •
                    </button>
                    <button onclick="downloadFinishedExcel()" class="btn btn-success btn-sm py-0" style="font-size: 0.75rem;">
                        <i class="bi bi-file-earmark-excel"></i> ì—‘ì…€ë‹¤ìš´ë¡œë“œ
                    </button>

                    <button onclick="processSettlement()" class="btn btn-warning btn-sm py-0 fw-bold" style="font-size: 0.75rem;">
                        <i class="bi bi-calculator-fill"></i> ì •ì‚°í•˜ê¸°
                    </button>

                </div>
            </div>

            <div class="card-body p-0" style="position: relative;">
                <div id="finishedGrid" class="ag-theme-quartz" style="width: 100%; height: 100%;">
                    </div>
            </div>
        </div>
    </div>

    <div style="flex: 2;">
        <div class="card shadow-sm border-secondary border-opacity-25 h-100 d-flex flex-column" style="overflow: hidden;">
            <div class="card-header small bg-light text-secondary d-flex justify-content-between align-items-center">
                <h6 class="m-0 fw-bold text-primary" style="font-size: 0.9rem;"><i class="bi bi-file-earmark-text"></i> ê²¬ì  ìƒì„¸ ë‚´ì—­</h6>
                <span id="selectedQtDisplay" class="badge bg-secondary" style="font-size: 0.7rem;">QTë²ˆí˜¸: -</span>
            </div>
            <div id="estimateDetailArea" class="table-responsive flex-grow-1" style="overflow-y: auto;">
                <table class="table table-sm table-hover table-bordered mb-0" style="font-size: 0.8rem;">
                    <thead class="table-light sticky-top">
                        <tr class="text-center">
                            <th style="width: 35px;">NO</th>
                            <th>ì‹œí—˜í•­ëª©</th>
                            <th style="width: 40px;">ìˆ˜ëŸ‰</th>
                            <th style="width: 70px;">ë‹¨ê°€</th>
                            <th style="width: 80px;">ê¸ˆì•¡</th>
                        </tr>
                    </thead>
                    <tbody id="estimateDetailBody">
                        <tr>
                            <td colspan="5" class="text-center py-5 text-muted small">ìƒë‹¨ ë¦¬ìŠ¤íŠ¸ì˜ í–‰ì„ í´ë¦­í•˜ì„¸ìš”.</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div style="flex: 2;">
        <div class="card shadow-sm border-secondary border-opacity-25 h-100 d-flex flex-column" style="overflow: hidden;">
            <div class="card-header small bg-light text-secondary d-flex justify-content-between align-items-center">
                <h6 class="m-0 fw-bold text-success" style="font-size: 0.9rem;"><i class="bi bi-calculator"></i> ê³µê¸‰ê¸ˆì•¡ ìƒì„¸ ìš”ì•½</h6>
            </div>
            <div class="flex-grow-1 overflow-auto p-1">
                <table class="table table-sm table-bordered mb-0" style="font-size: 0.78rem; table-layout: fixed; border-collapse: collapse;">
                    <tbody class="text-center">
                        <tr>
                            <th class="table-light" style="width: 35%;">ê¸° ì¤€ ë‹¨ ê°€</th>
                            <td colspan="3" class="text-end px-2" id="sum_base_price" style="background-color: #e7f3ff;">0</td>
                        </tr>
                        <tr>
                            <th class="table-light">ê¸°ë³¸ë£Œ ìˆ˜ëŸ‰</th>
                            <td class="text-end px-2" id="cnt_base">0</td>
                            <th class="table-light">ê¸° ë³¸ ë£Œ</th>
                            <td class="text-end px-2" id="sum_base_fee">0</td>
                        </tr>
                        <tr>
                            <th class="table-light">ì •ë³´ì²˜ë¦¬ ìˆ˜ëŸ‰</th>
                            <td class="text-end px-2" id="cnt_info">0</td>
                            <th class="table-light">ì • ë³´ ì²˜ ë¦¬</th>
                            <td class="text-end px-2" id="sum_info_fee">0</td>
                        </tr>
                        <tr>
                            <th class="table-light">ì¡°ê±´ ìˆ˜ìˆ˜ë£Œ</th>
                            <td class="text-end px-2" id="sum_cond_fee">0</td>
                            <th class="table-light">ì‹œí¸ ì œì‘ë¹„</th>
                            <td class="text-end px-2" id="sum_specimen_fee">0</td>
                        </tr>
                        <tr>
                            <th class="table-light">ì¶œ ì¥ êµ¬ ë¶„</th>
                            <td class="text-end px-2" id="val_travel_type">-</td>
                            <th class="table-light">ì¶œ ì¥ ë¹„</th>
                            <td class="text-end px-2" id="sum_travel_fee">0</td>
                        </tr>
                        <tr>
                            <th class="table-light">í• ì¸ì œì™¸ì•¡</th>
                            <td class="text-end px-2" id="sum_no_discount">0</td>
                            <th class="table-light">í• ì¸ê°€ëŠ¥ì•¡</th>
                            <td class="text-end px-2" id="sum_yes_discount">0</td>
                        </tr>
                        <tr>
                            <th class="table-light">í•  ì¸ ìœ¨</th>
                            <td class="text-end px-2 text-primary fw-bold" id="val_discount_rate">0%</td>
                            <th class="table-light">ì •ì•¡ í• ì¸</th>
                            <td class="text-end px-2 text-danger" id="val_fixed_discount">0</td>
                        </tr>
                        <tr>
                            <th class="table-dark" style="color: white; font-size: 0.75rem;">ê³µê¸‰ê°€ì•¡</th>
                            <td class="text-end px-2 fw-bold" id="total_supply_price" style="background-color: #e7f3ff;">0</td>
                            <th class="table-dark" style="color: white; font-size: 0.75rem;">ë¶€ê°€ì„¸</th>
                            <td class="text-end px-2 fw-bold" id="total_vat" style="background-color: #e7f3ff;">0</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

</div>
</div>
<div class="modal fade" id="settlementModal" tabindex="-1" aria-labelledby="settlementModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl"> <div class="modal-content">
            
            <div class="modal-header bg-warning text-dark py-2" style="cursor: move;">
                <h5 class="modal-title fw-bold fs-6" id="settlementModalLabel">
                    <i class="bi bi-calculator-fill"></i> í˜„ì¥íŒ€ ìš©ì—­ë¹„ ì •ì‚° ì²˜ë¦¬
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <div class="modal-body p-3">
                <div class="d-flex flex-wrap align-items-center gap-3 mb-3 p-2 border rounded bg-light">
                    <div class="d-flex align-items-center">
                        <span class="fw-bold small me-2 text-primary">ì¢…ëª© ì„ íƒ :</span>
                        <select id="m_item_selector" class="form-select form-select-sm" style="width: 180px;" onchange="applyItemStandard()">
                            <option value="">-- ì¢…ëª© ì„ íƒ --</option>
                            </select>
                    </div>
                    <div class="d-flex align-items-center gap-1 border-end pe-3 me-2">
                        <span class="badge bg-secondary">DBê¸°ì¤€</span>
                        <input type="text" id="db_base_val" class="form-control form-control-sm text-center bg-white" style="width: 50px;" readonly placeholder="ê³µìˆ˜">
                        <input type="text" id="db_price_val" class="form-control form-control-sm text-center bg-white" style="width: 80px;" readonly placeholder="ë‹¨ê°€">
                        <input type="text" id="db_extra_val" class="form-control form-control-sm text-center bg-white" style="width: 70px;" readonly placeholder="ì¶”ê°€">
                    </div>
                    <div class="d-flex align-items-center">
                        <span class="fw-bold small me-2">ì¶œì¥ë¹„ ë³€ê²½ :</span>
                        <div class="input-group input-group-sm" style="width: 150px;">
                            <button class="btn btn-outline-secondary" onclick="adjustValue('m_travel_fee', -10000)">-</button>
                            <input type="number" id="m_travel_fee" class="form-control text-center fw-bold" value="0">
                            <button class="btn btn-outline-secondary" onclick="adjustValue('m_travel_fee', 10000)">+</button>
                        </div>
                    </div>

                    <div class="d-flex align-items-center">
                        <span class="fw-bold small me-2">ì¶”ê°€ ê¸ˆì•¡ :</span>
                        <div class="input-group input-group-sm" style="width: 140px;">
                            <button class="btn btn-outline-secondary" onclick="adjustValue('m_extra_fee', -5000)">-</button>
                            <input type="number" id="m_extra_fee" class="form-control text-center fw-bold" value="0">
                            <button class="btn btn-outline-secondary" onclick="adjustValue('m_extra_fee', 5000)">+</button>
                        </div>
                    </div>

                    <div class="d-flex align-items-center">
                        <span class="fw-bold small me-2">ê³µìˆ˜ :</span>
                        <div class="input-group input-group-sm" style="width: 110px;">
                            <button class="btn btn-outline-secondary" onclick="adjustValue('m_work_count', -1)">-</button>
                            <input type="text" id="m_work_count" class="form-control text-center fw-bold" value="1" style="color: #ff00ff;">
                            <button class="btn btn-outline-secondary" onclick="adjustValue('m_work_count', 1)">+</button>
                        </div>
                    </div>

                    <div class="d-flex align-items-center gap-2 flex-grow-1 border-start ps-3">
                        <div class="d-flex align-items-center">
                            <span class="fw-bold small me-1 text-nowrap">í˜„ì¥ë‹´ë‹¹:</span>
                            <!-- <input type="text" id="m_edit_manager" class="form-control form-control-sm" style="width: 80px;" placeholder="ì´ë¦„"> -->
                             <select id="m_edit_manager" class="form-select form-select-sm" style="width: 100px;">
                                <option value="">ì„ íƒ</option>
                                <option value="ìœ„ì¬ì™„">ìœ„ì¬ì™„</option>
                                <option value="ì–‘ì§€í›ˆ">ì–‘ì§€í›ˆ</option>
                                <option value="ê¶Œì„ê·œ">ê¶Œì„ê·œ</option>
                                <option value="ì˜¤ë²”ì„">ì˜¤ë²”ì„</option>
                            </select>
                        </div>

                        <div class="d-flex align-items-center">
                            <span class="fw-bold small me-1 text-nowrap">ì—…ì²´ëª…:</span>
                            <input type="text" id="m_edit_builder" class="form-control form-control-sm" style="width: 140px;" placeholder="ì—…ì²´ëª…">
                        </div>

                        <button type="button" onclick="applyManualChanges()" class="btn btn-dark btn-sm fw-bold text-nowrap">ë³€ê²½</button>

                        <div class="d-flex align-items-center flex-grow-1 ms-2">
                            <span class="fw-bold small me-2 text-nowrap">ë¹„ê³ :</span>
                            <input type="text" id="m_memo" class="form-control form-control-sm" placeholder="ë¹„ê³  ì…ë ¥">
                        </div>
                    </div>

                    <div class="d-flex gap-1">
                        <button onclick="updateTableReflection()" class="btn btn-primary btn-sm fw-bold">ì •ì‚°í•˜ê¸°</button>
                        <button onclick="saveToDatabase()" class="btn btn-danger btn-sm fw-bold">DBì €ì¥</button>
                    </div>
                </div>

                <div class="table-responsive border rounded" style="max-height: 400px; overflow-x: auto;">
                    <table class="table table-sm table-bordered mb-0" style="font-size: 0.75rem; min-width: 1300px; white-space: nowrap;">
                        <thead class="table-light sticky-top text-center">
                            <tr>
                                <th>ì‹œí—˜ìˆ˜ê±°ì¼</th><th>í˜„ì¥ë‹´ë‹¹</th><th>êµ¬ë¶„</th><th>ì˜ë¢°ì—…ì²´ëª…</th>
                                <th>ì‹œë£Œëª…</th><th>ê³µìˆ˜</th><th>ì¶œì¥ë¹„</th><th>ì¶”ê°€</th>
                                <th>ë¹„ê³ </th><th>ì ‘ìˆ˜ë²ˆí˜¸</th><th>ì˜ì—…ë‹´ë‹¹</th><th>ì§€ê¸‰ì—¬ë¶€</th>
                            </tr>
                        </thead>
                        <tbody id="settlementTargetList"></tbody>
                    </table>
                </div>
            </div>

            <div class="modal-footer py-1">
                <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">ë‹«ê¸°</button>
            </div>
        </div>
    </div>
</div>
<script>
// [ê·¸ë¦¬ë“œ ì •ì˜] ì»¬ëŸ¼ ìˆœì„œ ê³ ì •: ì²´í¬ë°•ìŠ¤ -> ë‚ ì§œ -> ì œëª©
const columnDefs = [
    { 
        headerName: "", 
        width: 50, 
        checkboxSelection: true, 
        headerCheckboxSelection: true, 
        pinned: 'left', 
        lockPosition: 'left' // [ì¶”ê°€] ì‚¬ìš©ìê°€ ëŒì–´ì„œ ìˆœì„œë¥¼ ë°”ê¾¸ì§€ ëª»í•˜ê²Œ ê³ ì •
    },
    { 
        headerName: "ë‚ ì§œ",
        field: "date",      // ë°±ì—”ë“œì—ì„œ ì£¼ëŠ” í‚¤ ê°’ (ì¤‘ìš”!) 
        width: 100, 
        pinned: 'left', 
        lockPosition: 'left' // [ì¶”ê°€] ë‚ ì§œ ìœ„ì¹˜ ê³ ì •
    },
    { 
        headerName: "ë²”ì£¼", 
        field: "category",  // ë°±ì—”ë“œì˜ item["category"]ì™€ ë§¤ì¹­ [ì¶”ê°€]
        width: 120,
        cellClass: 'text-center'
    },
    { 
        headerName: "ì œëª©",
        field: "title",     // ë°±ì—”ë“œì—ì„œ ì£¼ëŠ” í‚¤ ê°’ (ì¤‘ìš”!) 
        // flex: 1, 
        // pinned: 'left' 
        width: 700, // flexë¥¼ ë¹¼ê³  ì¶©ë¶„íˆ ë„“ì€ ê°’ì„ ì¤ë‹ˆë‹¤.
        filter: 'agTextColumnFilter',
        // ë‚´ìš©ì´ ê¸¸ë©´ ë§ì¤„ì„í‘œ(...) í‘œì‹œ
        cellStyle: { 'text-overflow': 'ellipsis', 'white-space': 'nowrap', 'overflow': 'hidden' }
    }
];

let gridApi;

const gridOptions = {
    columnDefs: columnDefs,
    defaultColDef: { 
        sortable: true, 
        filter: true,           
        floatingFilter: false,
        cellStyle: { fontSize: '12px' },
        resizable: true
    },
    suppressMovableColumns: true,
    rowSelection: 'multiple',
    headerHeight: 25,
    rowHeight: 25,
    rowData: [],

    // [ìˆ˜ì •] ë³µì¡í•œ ë¹„êµ ë¡œì§ì„ ë‹¤ ì§€ìš°ê³  ì•„ë˜ ë‚´ìš©ë§Œ ë‚¨ê¹ë‹ˆë‹¤.
    rowClassRules: {
        'highlight-row': (params) => {
            return params.data && params.data.isCompleted === true;
        }
    },
    // [í•µì‹¬ ì¶”ê°€] ì…€ì„ í´ë¦­í–ˆì„ ë•Œ ì‹¤í–‰ë˜ëŠ” í•¨ìˆ˜
    onCellClicked: (params) => {
        // 1. í´ë¦­í•œ ì»¬ëŸ¼ì´ 'ì œëª©(title)'ì¸ì§€ í™•ì¸
        if (params.column.colId === 'title') {
            const fullText = params.value; // ì…€ì˜ í…ìŠ¤íŠ¸ ê°’
            
            if (fullText && fullText.includes('/')) {
                // 2. "/"ë¡œ ìŠ¤í”Œë¦¿í•˜ì—¬ 3ë²ˆì§¸ ë°ì´í„° ì¶”ì¶œ
                const parts = fullText.split('/');
                
                if (parts.length >= 3) {
                    const builderName = parts[3].trim();
                    
                    // 3. ìš°ì¸¡ ì‹œê³µì‚¬ ì…ë ¥ë€(ID: db_builderSearch)ì— ê°’ ë„£ê¸°
                    const builderInput = document.getElementById('db_builderSearch');
                    if (builderInput) {
                        builderInput.value = builderName;
                        
                        // ì…ë ¥ íš¨ê³¼ë¥¼ ì‹œê°ì ìœ¼ë¡œ ë³´ì—¬ì£¼ê¸° ìœ„í•œ í¬ì»¤ìŠ¤
                        builderInput.focus(); 
                        console.log("ì‹œê³µì‚¬ ë§¤ì¹­ ì™„ë£Œ:", builderName);
                    }
                }
            }
        }
    }
};

// QT DBìš© ì»¬ëŸ¼ ì •ì˜
let dbGridApi;
const dbColumnDefs = [
    { 
        headerName: "", 
        width: 50, 
        checkboxSelection: true,         // ì²´í¬ë°•ìŠ¤ í™œì„±í™”
        headerCheckboxSelection: true,   // í—¤ë” ì „ì²´ ì„ íƒ í™œì„±í™”
        pinned: 'left', 
        lockPosition: 'left' 
    },
    { headerName: "ì˜ì—…ë‹´ë‹¹", field: "sales", width: 90 },
    { headerName: "ì ‘ìˆ˜ë²ˆí˜¸", field: "receipt_code", width: 110 },
    { headerName: "í˜„ì¥ì‹œí—˜ì", field: "field_tester", width: 100 },
    { headerName: "ì±„ì·¨ì¼", field: "getdate", width: 100 },
    { headerName: "ì‹¤ì ‘ìˆ˜ì¼", field: "request_day", width: 100 },
    { headerName: "ì‹œê³µì‚¬", field: "builder", width: 150 },
    { headerName: "í˜„ì¥ëª…", field: "construction", width: 200 },
    { headerName: "ì‹œë£Œëª…", field: "specimen", width: 150 },
    { headerName: "ì‹œë£ŒëŸ‰", field: "specimen_qty", width: 80 },
    { headerName: "ê³µê¸‰ê°€ì•¡", field: "supply_value", width: 100, valueFormatter: params => params.value?.toLocaleString() },
    { headerName: "ë¶€ê°€ì„¸", field: "vat", width: 90, valueFormatter: params => params.value?.toLocaleString() },
    { headerName: "ì˜ë¢°ì¸", field: "cm_name", width: 100 },
    { headerName: "í’ˆì§ˆë‹´ë‹¹", field: "qm_name", width: 100 }
];

const dbGridOptions = {
    columnDefs: dbColumnDefs,
    rowSelection: 'multiple', // ì—¬ëŸ¬ í–‰ ì„ íƒ ê°€ëŠ¥í•˜ë„ë¡ ì„¤ì •
    defaultColDef: {
        sortable: true,
        filter: true,
        resizable: true,
        flex: 0, 
        cellStyle: { fontSize: '12px' },
        suppressSizeToFit: true 
    },
    autoSizeStrategy: {
        type: 'none' 
    },
    headerHeight: 25,
    rowHeight: 25,
    rowData: [],

    // â­ í´ë¦­ ì´ë²¤íŠ¸ ìˆ˜ì •: 'receipt_code'ë¥¼ ì§ì ‘ ì°¸ì¡°í•˜ë„ë¡ ë³€ê²½
    onRowClicked: (params) => {
    // 1. ë‹¨ì¼ í•„ë“œ ì¶”ì¶œ
        const receiptNo = params.data.receipt_code;

        // 2. ê°’ì´ ìˆì„ ë•Œë§Œ ì‹¤í–‰í•˜ëŠ” ì•ˆì „ì¥ì¹˜
        if (receiptNo) {
            console.log("[ì¡°íšŒ ì‹œì‘] ì ‘ìˆ˜ë²ˆí˜¸:", receiptNo);
            fetchDataByReceiptNo(receiptNo);
        } else {
            console.warn("ë°ì´í„°ì— receipt_codeê°€ í¬í•¨ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤.");
        }
    },

    onGridReady: (params) => {
        console.log("QT DB ê·¸ë¦¬ë“œ ì¤€ë¹„ ì™„ë£Œ");
    }
};




document.addEventListener('DOMContentLoaded', () => {
    // 1. ì¢Œì¸¡ ê·¸ë¦¬ë“œ (ë¹„ì¦ˆë©”ì¹´) ì´ˆê¸°í™”
    const bizDiv = document.querySelector('#bizmekaGrid');
    if (bizDiv) {
        gridApi = agGrid.createGrid(bizDiv, gridOptions);
    }

    // 2. ìš°ì¸¡ ê·¸ë¦¬ë“œ (QT DB) ì´ˆê¸°í™” - ì´ ë¶€ë¶„ì´ ì¶”ê°€ë˜ì–´ì•¼ ì¡°íšŒê°€ ì‘ë™í•©ë‹ˆë‹¤.
    const dbDiv = document.querySelector('#dbGrid');
    if (dbDiv) {
        // ë°˜ë“œì‹œ ìŠ¤í¬ë¦½íŠ¸ ìƒë‹¨ì— let dbGridApi; ì™€ const dbGridOptions ê°€ ì •ì˜ë˜ì–´ ìˆì–´ì•¼ í•©ë‹ˆë‹¤.
        dbGridApi = agGrid.createGrid(dbDiv, dbGridOptions);
        console.log("ìš°ì¸¡ ê·¸ë¦¬ë“œ ì´ˆê¸°í™” ì™„ë£Œ");
    }

    // --- ë‚ ì§œ ìë™ ì„¸íŒ… (ì´í›„ ë™ì¼) ---
    const startDateInput = document.getElementById('db_startDate');
    const endDateInput = document.getElementById('db_endDate');

    const today = new Date();
    const endValue = today.toISOString().split('T')[0];
    endDateInput.value = endValue;

    const startDate = new Date(today.getFullYear(), today.getMonth() - 3, 1);
    const startYear = startDate.getFullYear();
    const startMonth = String(startDate.getMonth() + 1).padStart(2, '0');
    const startValue = `${startYear}-${startMonth}-01`;
    startDateInput.value = startValue;
});

/* --- ê¸°ëŠ¥ í•¨ìˆ˜ (ê¸°ì¡´ ìœ ì§€) --- */
function syncBizmeka() {
    gridApi.showLoadingOverlay();
    const year = document.getElementById('search-year').value;
    const month = document.getElementById('search-month').value;
    fetch(`/bizmeka-sync/?year=${year}&month=${month}`)
        .then(res => res.json())
        .then(res => {
            gridApi.setGridOption('rowData', res.data || []);
            gridApi.hideOverlay();
        })
        .catch(() => {
            gridApi.setGridOption('rowData', []);
            gridApi.hideOverlay();
        });
}

function deleteSelected() {
    const rows = gridApi.getSelectedRows();
    if (rows.length > 0 && confirm("ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) gridApi.applyTransaction({ remove: rows });
}

function downloadExcel() {
    // 1. gridApi ì¡´ì¬ ì—¬ë¶€ í™•ì¸ (ì—ëŸ¬ ë°©ì§€ í•µì‹¬)
    if (!gridApi) {
        alert("ê·¸ë¦¬ë“œê°€ ì•„ì§ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
        return;
    }

    const exportData = [];
    
    // 2. ë°ì´í„° ì¶”ì¶œ ë° í•œê¸€ í—¤ë” ë§¤í•‘
    // ì´ë¯¸ì§€(image_fdecea)ì—ì„œ ë³´ì´ëŠ” [ë‚ ì§œ, ë²”ì£¼, ì œëª©] ìˆœì„œë¡œ ì—‘ì…€ì„ êµ¬ì„±í•©ë‹ˆë‹¤.
    gridApi.forEachNode((node) => {
        if (node.data) {
            exportData.push({
                "ë‚ ì§œ": node.data.date || "",     // ë°±ì—”ë“œ í‚¤: date
                "ë²”ì£¼": node.data.category || "", // ë°±ì—”ë“œ í‚¤: category
                "ì œëª©": node.data.title || ""    // ë°±ì—”ë“œ í‚¤: title
            });
        }
    });

    if (exportData.length === 0) {
        alert("ë‹¤ìš´ë¡œë“œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
        return;
    }

    try {
        // XLSX ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì‚¬ìš©í•˜ì—¬ ì—‘ì…€ ìƒì„±
        const ws = XLSX.utils.json_to_sheet(exportData);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "ë¹„ì¦ˆë©”ì¹´ìˆ˜ì§‘");
        
        // íŒŒì¼ëª…: ë¹„ì¦ˆë©”ì¹´_2026-01-06.xlsx ì‹ìœ¼ë¡œ ì €ì¥
        const today = new Date().toISOString().split('T')[0];
        XLSX.writeFile(wb, `ë¹„ì¦ˆë©”ì¹´_ë°ì´í„°_${today}.xlsx`);
        
    } catch (e) {
        console.error("ì—‘ì…€ ì €ì¥ ì¤‘ ì—ëŸ¬:", e);
        alert("ì—‘ì…€ íŒŒì¼ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë¸Œë¼ìš°ì € ì½˜ì†”ì„ í™•ì¸í•˜ì„¸ìš”.");
    }
}

function uploadExcel() {
    if (!gridApi) {
        alert("ê·¸ë¦¬ë“œê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
        return;
    }

    const input = document.createElement("input");
    input.type = "file";
    input.accept = ".xlsx, .xls"; // ì—‘ì…€ íŒŒì¼ë§Œ ì„ íƒ ê°€ëŠ¥í•˜ë„ë¡ ì œí•œ
    
    input.onchange = (e) => {
        const file = e.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = (ev) => {
            try {
                const data = new Uint8Array(ev.target.result);
                const wb = XLSX.read(data, { type: "array" });
                
                // 1. ì²« ë²ˆì§¸ ì‹œíŠ¸ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
                const rawData = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
                
                // 2. [í•µì‹¬] ì—‘ì…€ì˜ í•œê¸€ í—¤ë”ë¥¼ ì˜ë¬¸ í•„ë“œëª…ìœ¼ë¡œ ë§¤í•‘ (ë°ì´í„° ë³€í™˜)
                const mappedData = rawData.map(row => ({
                    date: row["ë‚ ì§œ"] || "",      // ì—‘ì…€ì˜ 'ë‚ ì§œ' ì—´ -> date í•„ë“œ
                    category: row["ë²”ì£¼"] || "",  // ì—‘ì…€ì˜ 'ë²”ì£¼' ì—´ -> category í•„ë“œ
                    title: row["ì œëª©"] || ""      // ì—‘ì…€ì˜ 'ì œëª©' ì—´ -> title í•„ë“œ
                }));

                // 3. ê·¸ë¦¬ë“œì— ë°ì´í„° ì ìš© (ìµœì‹  ë²„ì „ ë°©ì‹)
                gridApi.setGridOption('rowData', mappedData);
                
                alert(`ì´ ${mappedData.length}ê±´ì˜ ë°ì´í„°ë¥¼ ê°€ì ¸ì™”ìŠµë‹ˆë‹¤.`);
            } catch (err) {
                console.error("íŒŒì¼ ì½ê¸° ì˜¤ë¥˜:", err);
                alert("ì—‘ì…€ íŒŒì¼ì„ ì½ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            }
        };
        reader.readAsArrayBuffer(file);
    };
    input.click();
}

function onDbSearch() {
    if (!dbGridApi) {
        console.error("ê·¸ë¦¬ë“œê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
        return;
    }

    // ë¡œë”© ì‹œì‘ (v32 ë°©ì‹)
    dbGridApi.setGridOption('loading', true);

    const startDate = document.getElementById('db_startDate').value;
    const endDate = document.getElementById('db_endDate').value;
    const builder = document.getElementById('db_builderSearch').value;

    // API í˜¸ì¶œ
    fetch(`/get_qt_db_data/?startDate=${startDate}&endDate=${endDate}&builder=${encodeURIComponent(builder)}`)
        .then(res => res.json())
        .then(res => {
            console.log("ë°›ì€ ë°ì´í„°:", res); // ë¸Œë¼ìš°ì € ì½˜ì†”ì—ì„œë„ í™•ì¸ ê°€ëŠ¥
            if (res.status === 'success') {
                // ë°ì´í„°ë¥¼ ê·¸ë¦¬ë“œì— ì„¤ì •
                dbGridApi.setGridOption('rowData', res.data || []);
                
                if (res.data.length === 0) {
                    console.warn("ì¡°íšŒëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
                }
            } else {
                alert("ì¡°íšŒ ì—ëŸ¬: " + res.message);
            }
        })
        .catch(err => console.error("ë„¤íŠ¸ì›Œí¬ ì—ëŸ¬:", err))
        .finally(() => {
            // ë¡œë”© í•´ì œ
            dbGridApi.setGridOption('loading', false);
        });
}

/**
 * 1. ìƒë‹¨ í‘œ í–‰ í´ë¦­ ì´ë²¤íŠ¸ ì„¤ì •
 * í˜ì´ì§€ ë¡œë“œ í›„ ë˜ëŠ” í‘œ ë°ì´í„° ë Œë”ë§ í›„ ì‹¤í–‰í•˜ì„¸ìš”.
 */
function initTableClickEvent() {
    // ì´ë¯¸ì§€ìƒ ìƒë‹¨ í‘œì˜ tbody IDê°€ 'topTableBody'ë¼ê³  ê°€ì •í•©ë‹ˆë‹¤.
    const tableBody = document.getElementById('topTableBody');
    if (!tableBody) return;

    tableBody.addEventListener('click', function(e) {
        // í´ë¦­ëœ ìš”ì†Œì˜ ë¶€ëª¨ì¸ tr(í–‰)ì„ ì°¾ìŠµë‹ˆë‹¤.
        const row = e.target.closest('tr');
        if (!row) return;

        // 2ë²ˆì§¸ ì—´(Index 1)ì— ìˆëŠ” 'ì ‘ìˆ˜ë²ˆí˜¸'ë¥¼ ì¶”ì¶œí•©ë‹ˆë‹¤. [ì´ë¯¸ì§€ ê¸°ì¤€]
        const receiptNo = row.cells[1].innerText.trim();
        
        if (receiptNo && receiptNo !== "") {
            console.log("[ì¡°íšŒ ì‹œì‘] ì ‘ìˆ˜ë²ˆí˜¸:", receiptNo);
            fetchDataByReceiptNo(receiptNo);
            
            // í´ë¦­í•œ í–‰ í‘œì‹œ (ì„ íƒì‚¬í•­)
            document.querySelectorAll('#topTableBody tr').forEach(tr => tr.classList.remove('table-active'));
            row.classList.add('table-active');
        }
    });
}


//  * 2. ì„œë²„ì—ì„œ ìƒì„¸ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
async function fetchDataByReceiptNo(receiptNo) {
    try {
        // ì„œë²„ì˜ get_payment_detail ë·° í˜¸ì¶œ
        const response = await fetch(`/api/get_payment_detail?receipt_no=${receiptNo}`);
        const result = await response.json();

        if (result.success) {
            // [ì¤‘ì•™] ê²¬ì  ìƒì„¸ ë‚´ì—­ ì—…ë°ì´íŠ¸ (ê¸°ì¡´ í•¨ìˆ˜)
            renderEstimateDetail(result.estimate_items, result.qt_no);
            
            // [ìš°ì¸¡] ê³µê¸‰ê¸ˆì•¡ ìƒì„¸ ìš”ì•½ ì—…ë°ì´íŠ¸ (ê¸°ì¡´ í•¨ìˆ˜)
            updateSummaryTable(result.summary);
            
            console.log(`[ì„±ê³µ] ${receiptNo} ë°ì´í„° ë¡œë“œ ì™„ë£Œ`);
        } else {
            console.error("ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜:", result.message);
        }
    } catch (error) {
        console.error("ë„¤íŠ¸ì›Œí¬ í†µì‹  ì—ëŸ¬:", error);
    }
}
//  * 3. ê²¬ì  ìƒì„¸ ë‚´ì—­ ë Œë”ë§ (ê¸°ì¡´ ì½”ë“œ ìœ ì§€)
 /***/
function renderEstimateDetail(data, qtNo) {
    const body = document.getElementById('estimateDetailBody');
    const badge = document.getElementById('selectedQtDisplay');
    if (badge) badge.innerText = `QTë²ˆí˜¸: ${qtNo}`;
    if (!body) return;

    body.innerHTML = ''; 

    if (!data || data.length === 0) {
        body.innerHTML = '<tr><td colspan="5" class="text-center py-4">ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
        return;
    }

    data.forEach((item, index) => {
        body.innerHTML += `
            <tr>
                <td class="text-center">${index + 1}</td>
                <td>${item.ì‹œí—˜í•­ëª© || '-'}</td>
                <td class="text-center">${Number(item.ìˆ˜ëŸ‰ || 0).toLocaleString()}</td>
                <td class="text-end">${Number(item.ë‹¨ê°€ || 0).toLocaleString()}</td>
                <td class="text-end fw-bold text-primary">${Number(item.ê¸ˆì•¡ || 0).toLocaleString()}</td>
            </tr>`;
    });
}

/**
 * 4. ê³µê¸‰ê¸ˆì•¡ ìƒì„¸ ìš”ì•½ ë Œë”ë§ (ê¸°ì¡´ ì½”ë“œ ìœ ì§€)
 */
function updateSummaryTable(data) {
    const fmt = (num) => Number(num || 0).toLocaleString();
    let travelTypeText = (data.travel_type == '1') ? 'ë³¸ì›' : (data.travel_type == '2' ? 'ì§€ì›' : (data.travel_type || '-'));

    try {
        document.getElementById('sum_base_price').innerText = fmt(data.base_price);
        document.getElementById('cnt_base').innerText = data.base_cnt || 0;
        document.getElementById('sum_base_fee').innerText = fmt(data.base_fee);
        document.getElementById('cnt_info').innerText = data.info_cnt || 0;
        document.getElementById('sum_info_fee').innerText = fmt(data.info_fee);
        document.getElementById('sum_cond_fee').innerText = fmt(data.cond_fee);
        document.getElementById('sum_specimen_fee').innerText = fmt(data.specimen_fee);
        document.getElementById('val_travel_type').innerText = travelTypeText;
        document.getElementById('sum_travel_fee').innerText = fmt(data.travel_fee);
        document.getElementById('sum_no_discount').innerText = fmt(data.no_discount_amt);
        document.getElementById('sum_yes_discount').innerText = fmt(data.yes_discount_amt);
        document.getElementById('val_discount_rate').innerText = (data.discount_rate || 0) + "%";
        document.getElementById('val_fixed_discount').innerText = fmt(data.fixed_discount_amt);
        document.getElementById('total_supply_price').innerText = fmt(data.supply_value);
        document.getElementById('total_vat').innerText = fmt(data.vat);
    } catch (e) {
        console.error("[ì—ëŸ¬] ìš”ì•½í‘œ ë Œë”ë§ ì¤‘ ID ë§¤ì¹­ ì‹¤íŒ¨:", e);
    }
}

// í˜ì´ì§€ê°€ ë¡œë“œë  ë•Œ í´ë¦­ ì´ë²¤íŠ¸ë¥¼ í™œì„±í™”í•©ë‹ˆë‹¤.
document.addEventListener('DOMContentLoaded', initTableClickEvent);

// -----------------ì—¬ê¸°ì„œ ë¶€í„° ì™„ë£Œê±´ ë³´ê¸°-------------

// 1. ì „ì—­ ë³€ìˆ˜ ì„ ì–¸
let finishedGridApi;

// 2. ì™„ë£Œê±´ ë³´ê¸° ì»¬ëŸ¼ ì •ì˜ (ìˆœìˆ˜í•˜ê²Œ ì»¬ëŸ¼ ì •ì˜ë§Œ ë‚¨ê¹€)
const finishedColumnDefs = [
    { 
        headerName: "", 
        width: 40, 
        checkboxSelection: true, 
        headerCheckboxSelection: true, 
        pinned: 'left' 
    },
    { headerName: "ID", field: "ID", width: 60, pinned: 'left', editable: false, cellClass: 'bg-light' },
    { headerName: "ì‹œí—˜ìˆ˜ê±°ì¼", field: "ì‹œí—˜ìˆ˜ê±°ì¼", width: 110 },
    { headerName: "í˜„ì¥ë‹´ë‹¹", field: "í˜„ì¥ë‹´ë‹¹", width: 90 },
    { headerName: "êµ¬ë¶„", field: "êµ¬ë¶„", width: 80 },
    { headerName: "ì˜ë¢°ì—…ì²´ëª…", field: "ì˜ë¢°ì—…ì²´ëª…", width: 150 },
    { headerName: "ì‹œë£Œëª…", field: "ì‹œë£Œëª…", width: 150 },
    { headerName: "ê³µìˆ˜", field: "ê³µìˆ˜", width: 70 },
    { headerName: "ì¶œì¥ë¹„", field: "ì¶œì¥ë¹„", width: 90, valueFormatter: params => params.value?.toLocaleString() },
    { headerName: "ì¶”ê°€", field: "ì¶”ê°€", width: 80 },
    { headerName: "ë¹„ê³ ", field: "ë¹„ê³ ", width: 150 },
    { headerName: "ì ‘ìˆ˜ë²ˆí˜¸", field: "ì ‘ìˆ˜ë²ˆí˜¸", width: 120 },
    { headerName: "ì˜ì—…ë‹´ë‹¹", field: "ì˜ì—…ë‹´ë‹¹", width: 90 },
    { headerName: "ì‹œë£Œì±„ì·¨ì", field: "ì‹œë£Œì±„ì·¨ì", width: 100 },
    { headerName: "í˜„ì¥ì‹œí—˜ì", field: "í˜„ì¥ì‹œí—˜ì", width: 100 },
    { headerName: "ì§€ê¸‰ì—¬ë¶€", field: "ì§€ê¸‰ì—¬ë¶€", width: 80 },
    { headerName: "ìˆœë²ˆ", field: "ìˆœë²ˆ", width: 70 }
];

// 3. ê·¸ë¦¬ë“œ ì˜µì…˜ ì„¤ì • (ì—¬ê¸°ì— onGridReadyê°€ ìˆì–´ì•¼ í•¨)
const finishedGridOptions = {
    columnDefs: finishedColumnDefs,
    rowSelection: 'multiple',
    defaultColDef: {
        sortable: true,
        filter: true,
        resizable: true,
        editable: true,
        cellStyle: { fontSize: '12px' }
    },
    headerHeight: 25,
    rowHeight: 25,
    rowData: [],
    // ğŸŒŸ 31.x ë²„ì „ì—ì„œ ê°€ì¥ ì•ˆì „í•˜ê²Œ APIë¥¼ ì¡ëŠ” ë²•
    onGridReady: (params) => {
        window.finishedGridApi = params.api; // window ê°ì²´ì— ì¦‰ì‹œ í• ë‹¹
        finishedGridApi = params.api;        // ì „ì—­ ë³€ìˆ˜ì— í• ë‹¹
        console.log("í•˜ë‹¨ ê·¸ë¦¬ë“œ ì¤€ë¹„ ì™„ë£Œ!");
    }
};

// 4. í˜ì´ì§€ ë¡œë“œ ì‹œ ê·¸ë¦¬ë“œ ìƒì„±
document.addEventListener('DOMContentLoaded', () => {
    const gridDiv = document.querySelector('#finishedGrid');
    if (gridDiv) {
        // AG Grid ì´ˆê¸°í™”
        const api = agGrid.createGrid(gridDiv, finishedGridOptions);
        window.finishedGridApi = api; // ìƒì„±ê³¼ ë™ì‹œì— ë‹¤ì‹œ í•œë²ˆ í• ë‹¹
        finishedGridApi = api;
    }
});

// 5. ì¡°íšŒ í•¨ìˆ˜ (ë°©ì–´ ë¡œì§ ê°•í™”)
async function loadFinishedData() {
    // 1. í•˜ë‹¨ ê·¸ë¦¬ë“œ APIë§Œ ë¨¼ì € í™•ì¸í•©ë‹ˆë‹¤.
    const finishedApi = window.finishedGridApi;

    if (!finishedApi) {
        alert("í•˜ë‹¨ ê·¸ë¦¬ë“œ(ì™„ë£Œê±´) ë¡œë”© ì¤‘ì…ë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”.");
        return;
    }

    // ìƒë‹¨ ê·¸ë¦¬ë“œëŠ” ìˆìœ¼ë©´ ë§¤ì¹­í•˜ê³ , ì—†ìœ¼ë©´ ê·¸ëƒ¥ í•˜ë‹¨ ë°ì´í„°ë§Œ ë³´ì—¬ì¤ë‹ˆë‹¤.
    const upperApi = window.upperGridApi; 

    const year = document.getElementById('finish-year')?.value;
    const month = document.getElementById('finish-month')?.value;
    const manager = document.getElementById('finish-manager')?.value;

    if (!year || !month) {
        alert("ë…„ë„ì™€ ì›”ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
        return;
    }

    try {
        const response = await fetch(`/api/get_finished_data?year=${year}&month=${month}&manager=${manager}`);
        const result = await response.json();

        if (result.success) {
            // 2. í•˜ë‹¨ ê·¸ë¦¬ë“œì— ë°ì´í„° í‘œì‹œ (ì´ ì‘ì—…ì€ ìƒë‹¨ ê·¸ë¦¬ë“œ ìœ ë¬´ì™€ ìƒê´€ì—†ì´ ì‹¤í–‰ë¨)
            finishedApi.setGridOption('rowData', result.data);
            console.log("í•˜ë‹¨ ê·¸ë¦¬ë“œ ë°ì´í„° ë¡œë“œ ì™„ë£Œ");

            // 3. ìƒë‹¨ ê·¸ë¦¬ë“œê°€ ì¡´ì¬í•  ë•Œë§Œ ë§¤ì¹­(ìƒ‰ìƒ ë³€ê²½) ë¡œì§ ì‹¤í–‰
            if (upperApi) {
                const updatedRows = [];
                upperApi.forEachNode((node) => {
                    const row = { ...node.data };
                    // ... (ë§¤ì¹­ ë¡œì§ ë™ì¼) ...
                    row.isCompleted = result.data.some(item => {
                        const fDate = String(item.ì‹œí—˜ìˆ˜ê±°ì¼ || "").trim();
                        return row.date === fDate; // ì˜ˆì‹œ ë¹„êµ
                    });
                    updatedRows.push(row);
                });
                upperApi.setGridOption('rowData', updatedRows);
                console.log("ìƒë‹¨ ê·¸ë¦¬ë“œ ë§¤ì¹­ ì™„ë£Œ");
            } else {
                console.log("ìƒë‹¨ ê·¸ë¦¬ë“œê°€ ì—†ì–´ ë§¤ì¹­ ë¡œì§ì„ ê±´ë„ˆëœë‹ˆë‹¤.");
            }
        }
    } catch (error) {
        console.error("ì˜¤ë¥˜ ë°œìƒ:", error);
    }
}

// 1. í•¨ìˆ˜ë¥¼ ì „ì—­ ë²”ìœ„ì— ëª…ì‹œì ìœ¼ë¡œ ì„ ì–¸ (ReferenceError ë°©ì§€)
window.downloadFinishedExcel = async function() {
    console.log("ì—‘ì…€ ë‹¤ìš´ë¡œë“œ ì‹œì‘...");
    
    // í˜„ì¬ ì‘ì—… ì¤‘ì¸ í•˜ë‹¨ ê·¸ë¦¬ë“œ API í™•ì¸
    const gridApi = window.finishedGridApi;
    if (!gridApi) {
        alert("ê·¸ë¦¬ë“œê°€ ì•„ì§ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
        return;
    }

    let selectedRows = gridApi.getSelectedRows();
    if (selectedRows.length === 0) {
        selectedRows = [];
        gridApi.forEachNode(node => { if(node.data) selectedRows.push(node.data); });
    }

    if (selectedRows.length === 0) {
        alert("ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
        return;
    }

    try {
        const response = await fetch('/api/download_field_excel/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                // ğŸŒŸ ì—¬ê¸°ì„œ getCookie í•¨ìˆ˜ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({ items: selectedRows })
        });

        if (response.ok) {
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `í˜„ì¥ì •ì‚°_${new Date().toISOString().slice(0,10)}.xlsx`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
        } else {
            alert("ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        }
    } catch (error) {
        console.error("Download Error:", error);
        alert("ë‹¤ìš´ë¡œë“œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: " + error.message);
    }
};

// Django ë³´ì•ˆ(CSRF) í† í°ì„ ê°€ì ¸ì˜¤ëŠ” í•¨ìˆ˜
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// ğŸŒŸ window ê°ì²´ì— í• ë‹¹í•˜ì—¬ HTML ë²„íŠ¼ì´ ì¸ì‹í•  ìˆ˜ ìˆê²Œ í•©ë‹ˆë‹¤.
window.updateFinishedData = async function() {
    const gridApi = window.finishedGridApi;

    if (!gridApi) {
        alert("ê·¸ë¦¬ë“œ APIê°€ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
        return;
    }

    // 1. ì²´í¬ë°•ìŠ¤ë¡œ ì„ íƒëœ í–‰ë“¤ë§Œ ê°€ì ¸ì˜¤ê¸°
    const selectedRows = gridApi.getSelectedRows();

    if (selectedRows.length === 0) {
        alert("ìˆ˜ì • ì™„ë£Œ í›„, ì €ì¥í•  í•­ëª©ì„ ì²´í¬ë°•ìŠ¤ë¡œ ì„ íƒí•´ ì£¼ì„¸ìš”.");
        return;
    }

    if (!confirm(`ì„ íƒí•œ ${selectedRows.length}ê±´ì˜ ìˆ˜ì • ë‚´ìš©ì„ DBì— ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

    try {
        const response = await fetch('/api/update_finished_list/', { 
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken') // Django CSRF í† í° í•¨ìˆ˜ í•„ìš”
            },
            body: JSON.stringify({ items: selectedRows })
        });

        const result = await response.json();
        if (result.success) {
            alert(`ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤. (ì´ ${selectedRows.length}ê±´)`);
            gridApi.deselectAll(); // ì €ì¥ í›„ ì²´í¬ í•´ì œ
            
            // ì €ì¥ í›„ ë°ì´í„°ë¥¼ ë‹¤ì‹œ ë¶ˆëŸ¬ì™€ì„œ ê·¸ë¦¬ë“œë¥¼ ê°±ì‹ í•˜ê³  ì‹¶ë‹¤ë©´ ì•„ë˜ í˜¸ì¶œ
            // await loadFinishedData(); 
        } else {
            alert("ì €ì¥ ì‹¤íŒ¨: " + result.message);
        }
    } catch (error) {
        console.error("Update Error:", error);
        alert("ì €ì¥ ì¤‘ ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
    }
};

// -----------------ì™„ë£Œê±´ ë³´ê¸°ëŠ” ì—¬ê¸°ê¹Œì§€--------------

// -----------------ì—¬ê¸°ì„œ ë¶€í„° ì •ì‚°í•˜ê¸° ëª¨ë‹¬ ì°½------------
// [í†µí•© ë° ìˆ˜ì •] ì •ì‚°í•˜ê¸° ëª¨ë‹¬ ì‹¤í–‰ í•¨ìˆ˜
function processSettlement() {
    const bizRows = gridApi.getSelectedRows(); 
    const qtRows = dbGridApi.getSelectedRows(); 

    if (bizRows.length === 0 || qtRows.length === 0) {
        alert("ë¹„ì¦ˆë©”ì¹´ì™€ ê²¬ì  ë‚´ì—­ì„ ê°ê° ì„ íƒí•´ ì£¼ì„¸ìš”.");
        return;
    }

    const biz = bizRows[0];
    const qt = qtRows[0];

    // 1. [ìˆ˜ì •] ì‹œë£Œìˆ˜ê±° ìë™ ê²€ìƒ‰ ë° 50,000ì› ì…ë ¥ ë¡œì§ ì‚­ì œ
    // ì œëª© ë°ì´í„°ë§Œ ê°€ì ¸ì˜¤ê³ , ì¶”ê°€ ê¸ˆì•¡ì€ ê¸°ë³¸ 0ìœ¼ë¡œ ì„¤ì •í•©ë‹ˆë‹¤.
    const bizTitle = (biz.ì œëª© || biz.title || biz.item || biz.ì‹œë£Œëª… || "").toString();
    let autoExtraFee = 0; 

    // 2. [ìƒì„¸ í…Œì´ë¸” ìŠ¤ìºë‹] ì¶œì¥ë¹„ ë° ë‹¨ìœ„ìˆ˜ëŸ‰ ì¶”ì¶œ
    const detailRows = document.querySelectorAll('#estimateDetailBody tr');
    let travelFee = 0;
    let unitQuantityMemo = "";

    detailRows.forEach(row => {
        const cells = row.cells;
        if (cells.length < 4) return;
        const itemName = cells[1].innerText.trim();
        const itemQty = cells[2].innerText.trim();
        const itemPrice = cells[3].innerText.replace(/,/g, '').trim();

        if (itemName.includes("ì¶œì¥ë¹„")) {
            travelFee = parseFloat(itemPrice) || 0;
        }
        if (itemName.includes("ì½˜í¬ë¦¬íŠ¸ ë‹¨ìœ„ìˆ˜ëŸ‰")) {
            unitQuantityMemo = `${itemName} (${itemQty}íšŒ)`;
        }
    });

    // 3. í•„ë“œ ë§¤í•‘ (ë‚ ì§œ, ë‹´ë‹¹ì ë“± ëˆ„ë½ ë°©ì§€)
    const displayData = {
        date: biz.ì ‘ìˆ˜ì¼ì‹œ || biz.ë‚ ì§œ || biz.date || "-",
        manager: qt.í˜„ì¥ë‹´ë‹¹ || qt.ë‹´ë‹¹ì || qt.field_tester || qt.sales || "-",
        builder: qt.ì˜ë¢°ê¸°ê´€ëª… || qt.ì˜ë¢°ì—…ì²´ëª… || qt.builder || "-",
        receiptNo: qt.ì ‘ìˆ˜ë²ˆí˜¸ || qt.receipt_code || "-"
    };

    // 4. ëª¨ë‹¬ ìƒë‹¨ ì…ë ¥ì°½ì— ê°’ ì£¼ì…
    // ì¶”ê°€ ê¸ˆì•¡(m_extra_fee)ì€ ì´ì œ í•­ìƒ 0ìœ¼ë¡œ ì„¸íŒ…ë©ë‹ˆë‹¤.
    const extraFeeInput = document.getElementById('m_extra_fee');
    if (extraFeeInput) {
        extraFeeInput.value = autoExtraFee; 
    }
    document.getElementById('m_travel_fee').value = travelFee;
    document.getElementById('m_work_count').value = 1;
    document.getElementById('m_memo').value = unitQuantityMemo;

    // 5. ëª¨ë‹¬ í•˜ë‹¨ í‘œ ê°±ì‹  (ì§€ê¸‰ì—¬ë¶€ ì¹¸ì€ ë¹„ì›Œë‘ )
    const targetBody = document.getElementById('settlementTargetList');
    if (targetBody) {
        targetBody.innerHTML = "";
        const tr = document.createElement('tr');
        tr.className = 'text-center align-middle';
        tr.dataset.originalSpecimen = bizTitle;

        tr.innerHTML = `
            <td>${displayData.date}</td>
            <td>${displayData.manager}</td>
            <td>í˜„ì¥ì‹œí—˜</td>
            <td class="text-start">${displayData.builder}</td>
            <td class="text-start">${bizTitle}</td> 
            <td>1</td>
            <td class="text-end">${travelFee.toLocaleString()}</td>
            <td class="text-end text-danger">${autoExtraFee.toLocaleString()}</td>
            <td class="text-start">${unitQuantityMemo}</td>
            <td>${displayData.receiptNo}</td>
            <td>${qt.ì˜ì—…ë‹´ë‹¹ || qt.sales || '-'}</td>
            <td></td> 
        `;
        targetBody.appendChild(tr);
    }

    const modal = bootstrap.Modal.getOrCreateInstance(document.getElementById('settlementModal'));
    modal.show();
}


function updateTableReflection() {
    const targetRow = document.querySelector('#settlementTargetList tr');
    if (!targetRow) return;

    const selectedItemName = document.getElementById('m_item_selector').options[document.getElementById('m_item_selector').selectedIndex].text;
    const workCount = document.getElementById('m_work_count').value;
    const travelFee = document.getElementById('m_travel_fee').value;
    const extraFee = document.getElementById('m_extra_fee').value;
    let memo = document.getElementById('m_memo').value;

    // [ê·œì¹™ ì¶”ê°€] ë‹¨ìœ„ìˆ˜ëŸ‰ ìë™ ë¹„ê³  ìƒì„±
    const originalSpecimen = targetRow.dataset.originalSpecimen || "";
    if (originalSpecimen.includes("ì½˜í¬ë¦¬íŠ¸ ë‹¨ìœ„ìˆ˜ëŸ‰")) {
        const autoMemo = `ë‹¨ìœ„ìˆ˜ëŸ‰ ${workCount}íšŒ`;
        memo = memo ? `${memo} (${autoMemo})` : autoMemo;
    }

    // í‘œ ë‚´ìš© ë®ì–´ì“°ê¸°
    targetRow.cells[4].innerText = selectedItemName; 
    targetRow.cells[5].innerText = workCount;
    targetRow.cells[6].innerText = Number(travelFee).toLocaleString();
    targetRow.cells[7].innerText = Number(extraFee).toLocaleString();
    targetRow.cells[8].innerText = memo;
    
    targetRow.cells[4].style.color = 'blue';
    targetRow.cells[4].style.fontWeight = 'bold';
}

// 1. ê°’ ì¡°ì ˆ í•¨ìˆ˜ (-, + ë²„íŠ¼ ë™ì‘)
function adjustValue(id, step) {
    const el = document.getElementById(id);
    let val = parseFloat(el.value) || 0;
    el.value = val + step;
    updateTableReflection(); // ê°’ì´ ë°”ë€Œë©´ í‘œì— ì¦‰ì‹œ ë°˜ì˜
}

// 2. ëª¨ë‹¬ ì—´ê¸° ë° ì´ˆê¸° ë°ì´í„° ì„¸íŒ…


// 3. ìƒë‹¨ ì…ë ¥ê°’ì„ í‘œ(Table)ì— ì‹¤ì‹œê°„ ë°˜ì˜í•˜ëŠ” í•¨ìˆ˜ (ì •ì‚°í•˜ê¸° ë²„íŠ¼ í¬í•¨)


// 4. DB ì €ì¥ ë¡œì§ (Django Viewì™€ í†µì‹ )
function saveToDatabase() {
    if(!confirm("í˜„ì¬ ë‚´ì—­ì„ 'winapps_í˜„ì¥íŒ€' í…Œì´ë¸”ì— ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

    // ìµœì¢… ë°ì´í„° ìˆ˜ì§‘
    const data = {
        date: bizmekaGridApi.getSelectedRows()[0].ë‚ ì§œ,
        manager: "{{ user.username }}",
        customer: dbGridApi.getSelectedRows()[0].ì‹œê³µì‚¬,
        item: bizmekaGridApi.getSelectedRows()[0].ì œëª©,
        count: document.getElementById('m_work_count').value,
        travel_fee: document.getElementById('m_travel_fee').value,
        extra_fee: document.getElementById('m_extra_fee').value,
        memo: document.getElementById('m_memo').value,
        receipt_no: dbGridApi.getSelectedRows()[0].ì ‘ìˆ˜ë²ˆí˜¸,
        sales_manager: dbGridApi.getSelectedRows()[0].ì˜ì—…ë‹´ë‹¹
    };

    fetch('/save_field_settlement/', {
        method: 'POST',
        headers: { 'X-CSRFToken': '{{ csrf_token }}', 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
    })
    .then(res => res.json())
    .then(result => {
        if(result.success) {
            alert("DB ì €ì¥ ì„±ê³µ!");
            location.reload();
        } else {
            alert("ì €ì¥ ì‹¤íŒ¨: " + result.message);
        }
    });
}

// ëª¨ë‹¬ ë“œë˜ê·¸ ì´ë™ ê¸°ëŠ¥
document.addEventListener('mousedown', function (e) {
    // 1. í´ë¦­í•œ ê³³ì´ ëª¨ë‹¬ í—¤ë”ì¸ì§€ í™•ì¸
    const header = e.target.closest('.modal-header');
    if (!header) return;

    const modal = header.closest('.modal-content');
    if (!modal) return;

    // [í•µì‹¬ ì¶”ê°€] ë“œë˜ê·¸ ì‹œì‘ ì‹œ í˜„ì¬ ë„ˆë¹„ë¥¼ êµ¬í•´ì„œ ê³ ì •í•©ë‹ˆë‹¤.
    // ì´ë ‡ê²Œ í•´ì•¼ fixedë¡œ ë³€í•  ë•Œ ì°½ì´ ì»¤ì§€ì§€ ì•ŠìŠµë‹ˆë‹¤.
    const currentWidth = modal.offsetWidth;
    modal.style.width = currentWidth + 'px';
    modal.style.maxWidth = 'none'; // ë¶€íŠ¸ìŠ¤íŠ¸ë©ì˜ ìµœëŒ€ ë„ˆë¹„ ì œí•œ í•´ì œ

    // 2. ë“œë˜ê·¸ ì‹œì‘ ì‹œ ë§ˆìš°ìŠ¤ì™€ ëª¨ë‹¬ ì‚¬ì´ì˜ ê±°ë¦¬(ì¢Œí‘œ) ê³„ì‚°
    let offset = {
        x: e.clientX - modal.getBoundingClientRect().left,
        y: e.clientY - modal.getBoundingClientRect().top
    };

    function onMouseMove(e) {
        // 3. ëª¨ë‹¬ ìœ„ì¹˜ ì—…ë°ì´íŠ¸
        modal.style.position = 'fixed';
        modal.style.margin = '0';
        modal.style.left = (e.clientX - offset.x) + 'px';
        modal.style.top = (e.clientY - offset.y) + 'px';
        modal.style.zIndex = '1060'; // ë‹¤ë¥¸ ìš”ì†Œë³´ë‹¤ ìœ„ì— ì˜¤ë„ë¡ ì„¤ì •
    }

    function onMouseUp() {
        // 4. ë§ˆìš°ìŠ¤ë¥¼ ë–¼ë©´ ì´ë²¤íŠ¸ ì œê±°
        document.removeEventListener('mousemove', onMouseMove);
        document.removeEventListener('mouseup', onMouseUp);
    }

    document.addEventListener('mousemove', onMouseMove);
    document.addEventListener('mouseup', onMouseUp);
});

// 1. DB ê¸°ì¤€ ì •ë³´ (ì´ë¯¸ì§€ image_a592ff.png ê¸°ì¤€ ë°ì´í„° êµ¬ì„±)
// 1. [ë°±ì—…ìš©] DB ì—°ê²° ì‹¤íŒ¨ ì‹œë¥¼ ëŒ€ë¹„í•œ ìµœì†Œí•œì˜ ê¸°ë³¸ ëª©ë¡
const fallbackItems = [
    { id: 6, name: "ìƒì½˜", base: 3, price: "ì¶œì¥ë¹„", extra: 30000 },
    { id: 7, name: "ì–´ìŠ¤ì•µì»¤", base: 2, price: 200000, extra: 100000 },
    { id: 8, name: "ì½”ì•„ì±„ì·¨(ì•„ìŠ¤ì½˜)", base: 3, price: "ì¶œì¥ë¹„", extra: 10000 },
    { id: 9, name: "ì½”ì•„ì±„ì·¨(ì½˜í¬ë¦¬íŠ¸)", base: 1, price: 300000, extra: 50000 },
    { id: 18, name: "ëª°ë“œìˆ˜ê±°", base: 1, price: 0, extra: 0 },
    { id: 20, name: "ì‹œë£Œìˆ˜ê±°", base: 1, price: 0, extra: 50000 },
    { id: 21, name: "ì‹œë£Œì ‘ìˆ˜", base: 1, price: 0, extra: 50000 }
];

// ì „ì—­ ë³€ìˆ˜ë¡œ ê´€ë¦¬
let itemStandards = [];

// 2. [ìˆ˜ì •] DBì—ì„œ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë©”ì¸ í•¨ìˆ˜
async function loadItemStandards() {
    try {
        // DB API í˜¸ì¶œ
        const response = await fetch('/api/get-item-standards/'); 
        
        if (response.ok) {
            // DB ë°ì´í„° ë¡œë“œ ì„±ê³µ ì‹œ
            itemStandards = await response.json(); 
        } else {
            throw new Error("DB ì‘ë‹µ ì—ëŸ¬");
        }
    } catch (error) {
        console.warn("DB ë¡œë“œ ì‹¤íŒ¨, ë°±ì—… ëª©ë¡ì„ ì‚¬ìš©í•©ë‹ˆë‹¤:", error);
        // DB í˜¸ì¶œ ì‹¤íŒ¨ ì‹œ ë°±ì—…ìš© ë°ì´í„° ì‚¬ìš©
        itemStandards = fallbackItems; 
    }

    // ë“œë¡­ë‹¤ìš´ ìƒì„± ë¡œì§
    const selector = document.getElementById('m_item_selector');
    if (!selector) return;

    selector.innerHTML = '<option value="">-- ì¢…ëª© ì„ íƒ --</option>'; 
    itemStandards.forEach(item => {
        const opt = document.createElement('option');
        opt.value = item.id;
        opt.textContent = item.name;
        opt.dataset.base = item.base;
        opt.dataset.price = item.price;
        opt.dataset.extra = item.extra;
        selector.appendChild(opt);
    });
}

// 2. í˜ì´ì§€ ë¡œë“œ ì‹œ ë“œë¡­ë‹¤ìš´ ë©”ë‰´ ìƒì„±
document.addEventListener('DOMContentLoaded', () => {
    const selector = document.getElementById('m_item_selector');
    if(selector) {
        itemStandards.forEach(item => {
            const opt = document.createElement('option');
            opt.value = item.id;
            opt.textContent = item.name;
            selector.appendChild(opt);
        });
    }
});

// 3. ì¢…ëª© ì„ íƒ ì‹œ ìë™ ê°’ ë¿Œë¦¬ê¸° í•¨ìˆ˜

function applyItemStandard() {
    const selector = document.getElementById('m_item_selector');
    const selectedId = selector.value;
    const selectedText = selector.options[selector.selectedIndex].text;
    const item = itemStandards.find(i => i.id == selectedId);
    
    if (!item) return;

    // 1. [ìƒë‹¨ DBê¸°ì¤€ ì¹¸] ì—…ë°ì´íŠ¸ (ë¹„êµë¥¼ ìœ„í•œ ê¸°ì¤€ê°’ í‘œì‹œ)
    if(document.getElementById('db_base_val'))  document.getElementById('db_base_val').value = item.base;
    if(document.getElementById('db_price_val')) document.getElementById('db_price_val').value = item.price;
    if(document.getElementById('db_extra_val')) document.getElementById('db_extra_val').value = item.extra;

    // 2. [ê³µìˆ˜ ë¹„êµ ë¡œì§] â˜…ì´ ë¶€ë¶„ì´ ë‹¤ì‹œ í™œì„±í™”ë˜ì–´ì•¼ í•©ë‹ˆë‹¤â˜…
    const workCountInput = document.getElementById('m_work_count');
    const currentInputVal = Number(workCountInput.value) || 0;
    const dbBaseVal = Number(item.base);

    // [ì˜ˆì‹œ] ì…ë ¥ëœ ê³µìˆ˜ê°€ ê¸°ì¤€ê³µìˆ˜ë³´ë‹¤ ì‘ë‹¤ë©´ ê¸°ì¤€ê³µìˆ˜ë¡œ ë§ì¶°ì£¼ê³ , í¬ë‹¤ë©´ ì‚¬ìš©ìì˜ ì…ë ¥ì„ ì¡´ì¤‘í•¨
    // ë§Œì•½ "ë¬´ì¡°ê±´ ë¹„êµë§Œ í•˜ê³  ê°’ì€ ì•ˆ ë°”ê¾¸ê² ë‹¤"ë©´ ì´ ì¡°ê±´ë¬¸ì„ ë¹¼ê³  ë¹„êµ ë¡œì§ë§Œ ë„£ìœ¼ì‹œë©´ ë©ë‹ˆë‹¤.
    if (currentInputVal < dbBaseVal) {
        // ì…ë ¥ê°’ì´ ê¸°ì¤€ë³´ë‹¤ ì‘ì„ ë•Œë§Œ ê¸°ì¤€ê°’ìœ¼ë¡œ ì„¸íŒ… (ìµœì†Œ ê³µìˆ˜ ë³´ì¥)
        // workCountInput.value = dbBaseVal; 
    }

    // 3. [ì¶œì¥ë¹„ ì„¸íŒ…]
    if (item.price === "ì¶œì¥ë¹„") {
        const currentTravelFee = document.getElementById('m_travel_fee').value;
        if (!currentTravelFee || currentTravelFee == "0") {
            document.getElementById('m_travel_fee').value = 250000;
        }
    } else {
        document.getElementById('m_travel_fee').value = item.price;
    }

    // 4. [ì¶”ê°€ê¸ˆì•¡ & êµ¬ë¶„ ê·œì¹™] ê¹ê¹í•œ ì¡°ê±´ ê²€ì‚¬
    let extraFee = 0; 
    let category = "í˜„ì¥ì‹œí—˜"; 

    // ì‹œë£Œìˆ˜ê±°/ì ‘ìˆ˜ ì¡°ê±´ ì²´í¬
    if (["ì‹œë£Œìˆ˜ê±°", "ëª°ë“œìˆ˜ê±°", "ì‹œë£Œì ‘ìˆ˜"].includes(selectedText)) {
        category = "ì‹œë£Œìˆ˜ê±°"; 
        if (selectedText === "ì‹œë£Œìˆ˜ê±°" || selectedText === "ì‹œë£Œì ‘ìˆ˜") {
            extraFee = 50000; 
        }
    } else if (selectedText.includes("ì½”ì•„ì±„ì·¨")) {
        category = "ê¸°íƒ€";
    }

    // 5. [ì¶”ê°€ ë¡œì§] ê³µìˆ˜ ë¹„êµì— ë”°ë¥¸ ì¶”ê°€ê¸ˆì•¡ ë³´ì • (í•„ìš”ì‹œ ì‚¬ìš©)
    // ë§Œì•½ ì…ë ¥ê³µìˆ˜ê°€ ê¸°ì¤€ê³µìˆ˜ë³´ë‹¤ ë§ì„ ë•Œ ì¶”ê°€ê¸ˆì„ ë” ì¤€ë‹¤ê±°ë‚˜ í•˜ëŠ” ë¡œì§ì„ ì—¬ê¸° ë„£ìŠµë‹ˆë‹¤.
    if (currentInputVal > dbBaseVal) {
        console.log("ê¸°ì¤€ê³µìˆ˜ ì´ˆê³¼ ì…ë ¥ë¨: ë¡œì§ ìˆ˜í–‰ ê°€ëŠ¥");
    }

    document.getElementById('m_extra_fee').value = extraFee;
    updateTableReflection(category); 
}

function resetModalFields() {
    // 1. ì¢…ëª© ì„ íƒ ë“œë¡­ë‹¤ìš´ ì´ˆê¸°í™”
    const selector = document.getElementById('m_item_selector');
    if (selector) selector.selectedIndex = 0;

    // 2. ìƒë‹¨ DBê¸°ì¤€(íšŒìƒ‰ ì¹¸) ì´ˆê¸°í™”
    const dbFields = ['db_base_val', 'db_price_val', 'db_extra_val'];
    dbFields.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.value = '';
    });

    // 3. í•˜ë‹¨ ì‹¤ì œ ì…ë ¥ì°½ ì´ˆê¸°í™”
    if (document.getElementById('m_work_count')) document.getElementById('m_work_count').value = 1; // ê¸°ë³¸ê³µìˆ˜ 1ì„¸íŒ…
    if (document.getElementById('m_travel_fee')) document.getElementById('m_travel_fee').value = 0;
    if (document.getElementById('m_extra_fee'))  document.getElementById('m_extra_fee').value = 0;
    if (document.getElementById('m_memo'))       document.getElementById('m_memo').value = ''; // ë¹„ê³ ë€

    console.log("ëª¨ë‹¬ ì…ë ¥ ë°ì´í„°ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.");
}

// 2. í‘œ(Table) ë‚´ìš©ì„ ì—…ë°ì´íŠ¸í•˜ëŠ” í•¨ìˆ˜
function updateTableReflection(forcedCategory) {
    const targetRow = document.querySelector('#settlementTargetList tr');
    if (!targetRow) return;

    const selectedItemName = document.getElementById('m_item_selector').options[document.getElementById('m_item_selector').selectedIndex].text;
    const workCount = document.getElementById('m_work_count').value;
    const travelFee = document.getElementById('m_travel_fee').value;
    const extraFee = document.getElementById('m_extra_fee').value;
    let memo = document.getElementById('m_memo').value;

    // [í•´ê²°í¬ì¸íŠ¸] ì „ë‹¬ë°›ì€ êµ¬ë¶„(forcedCategory)ì´ ìˆë‹¤ë©´ í•´ë‹¹ ì…€(index 2)ì„ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.
    if (forcedCategory) {
        targetRow.cells[2].innerText = forcedCategory; // 'êµ¬ë¶„' ì¹¸ ê°•ì œ ë³€ê²½
    } else if (!targetRow.cells[2].innerText) {
        targetRow.cells[2].innerText = "í˜„ì¥ì‹œí—˜"; // ê°’ì´ ì•„ì˜ˆ ì—†ì„ ë•Œë§Œ ê¸°ë³¸ê°’
    }

    // ë‚˜ë¨¸ì§€ í‘œ ë‚´ìš© ì—…ë°ì´íŠ¸
    targetRow.cells[4].innerText = selectedItemName; // 'ì‹œë£Œëª…'
    targetRow.cells[5].innerText = workCount;
    targetRow.cells[6].innerText = Number(travelFee).toLocaleString();
    targetRow.cells[7].innerText = Number(extraFee).toLocaleString();
    targetRow.cells[8].innerText = memo;
    
    // ì‹œë£Œëª… ìŠ¤íƒ€ì¼ ê°•ì¡°
    targetRow.cells[4].style.color = 'blue';
    targetRow.cells[4].style.fontWeight = 'bold';
}

// ì´ˆê¸° ë¡œë“œ ì‹¤í–‰
document.addEventListener('DOMContentLoaded', loadItemStandards);

// ê³„ì‚°í•˜ê¸°
function calculateSettlement() {
    // 1. ê°’ ê°€ì ¸ì˜¤ê¸° (DBê¸°ì¤€ê°’ vs ì…ë ¥ê°’)
    const dbBase = parseInt(document.getElementById('db_base_val').value) || 0;    // DBê¸°ì¤€ ê¸°ë³¸(ê³µìˆ˜)
    const dbExtra = parseInt(document.getElementById('db_extra_val').value) || 0;  // DBê¸°ì¤€ ì¶”ê°€ê¸ˆì•¡
    const dbPrice = document.getElementById('db_price_val').value;                 // DBê¸°ì¤€ ë‹¨ê°€
    
    const inputWorkCount = parseInt(document.getElementById('m_work_count').value) || 0; // ì‚¬ìš©ìê°€ ì…ë ¥í•œ ê³µìˆ˜

    // 2. ê³µìˆ˜ ë¹„êµ ë° ì¶”ê°€ê¸ˆì•¡ ê³„ì‚° (ê·œì¹™ 2, 3)
    let finalExtraFee = 0;
    if (inputWorkCount > dbBase) {
        // ì…ë ¥ ê³µìˆ˜ê°€ ê¸°ë³¸ë³´ë‹¤ í¬ë©´: (ì…ë ¥ - ê¸°ë³¸) * DBì¶”ê°€ê¸ˆì•¡
        finalExtraFee = (inputWorkCount - dbBase) * dbExtra;
    } else {
        // ê°™ê±°ë‚˜ ì‘ìœ¼ë©´ 0ì›
        finalExtraFee = 0;
    }
    document.getElementById('m_extra_fee').value = finalExtraFee; // "ì¶”ê°€ê¸ˆì•¡"ì°½ì— ì…ë ¥

    // 3. ë‹¨ê°€ ë° ì¶œì¥ë¹„ ì²˜ë¦¬ (ê·œì¹™ 4)
    if (dbPrice !== "ì¶œì¥ë¹„" && dbPrice !== "") {
        // "ì¶œì¥ë¹„"ê°€ ì•„ë‹Œ íŠ¹ì • ê¸ˆì•¡ì´ ë“¤ì–´ìˆëŠ” ê²½ìš° ê·¸ ê¸ˆì•¡ì„ ì…ë ¥ì°½ì— ë„£ìŒ
        document.getElementById('m_travel_fee').value = dbPrice;
    }
    // "ì¶œì¥ë¹„"ë¼ê³  ë˜ì–´ìˆìœ¼ë©´ ê¸°ì¡´ ê°’ì„ ìœ ì§€í•˜ë¯€ë¡œ ë³„ë„ ì²˜ë¦¬ë¥¼ í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.

    // 4. í‘œì— ì¦‰ì‹œ ë°˜ì˜
    if (typeof updateTableReflection === 'function') {
        updateTableReflection();
    }
}

// ê³µìˆ˜ ì…ë ¥ì°½ì˜ + / - ë²„íŠ¼ì„ ëˆ„ë¥¼ ë•Œë§ˆë‹¤ ì´ í•¨ìˆ˜ê°€ ì‹¤í–‰ë˜ë„ë¡ ì—°ê²°í•´ì•¼ í•©ë‹ˆë‹¤.



// ìˆ«ìë¥¼ ì¦ê°ì‹œí‚¤ëŠ” ê¸°ì¡´ í•¨ìˆ˜ ìˆ˜ì •
function adjustValue(id, delta) {
    const input = document.getElementById(id);
    if (!input) return;

    let currentValue = parseFloat(input.value) || 0;
    let newValue = currentValue + delta;

    // ê³µìˆ˜ëŠ” 0ë³´ë‹¤ ì‘ì•„ì§ˆ ìˆ˜ ì—†ë„ë¡ ë°©ì–´
    if (id === 'm_work_count' && newValue < 0) newValue = 0;

    input.value = newValue;

    // í•µì‹¬: ê³µìˆ˜(m_work_count)ê°€ ë³€ê²½ë˜ì—ˆë‹¤ë©´ ì¦‰ì‹œ ê³„ì‚° í•¨ìˆ˜ ì‹¤í–‰
    if (id === 'm_work_count') {
        calculateSettlement(); 
    }
}

// ê³µìˆ˜ ì…ë ¥ì°½ì— ì§ì ‘ ìˆ«ìë¥¼ ì…ë ¥í–ˆì„ ë•Œë„ ì‹¤ì‹œê°„ ê³„ì‚°
document.getElementById('m_work_count').addEventListener('input', function() {
    calculateSettlement();
});

async function saveToDatabase() {
    const tableRows = document.querySelectorAll('#settlementTargetList tr');
    if (tableRows.length === 0) {
        alert("ì €ì¥í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ì •ì‚°í•˜ê¸°ë¥¼ ëˆŒëŸ¬ì£¼ì„¸ìš”.");
        return;
    }

    if (!confirm("í˜„ì¬ ì •ì‚° ë‚´ì—­ì„ DBì— ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

    const dataToSave = [];
    tableRows.forEach(row => {
        const cells = row.cells;
        dataToSave.push({
            'ì‹œí—˜ìˆ˜ê±°ì¼': cells[0].innerText,
            'í˜„ì¥ë‹´ë‹¹': cells[1].innerText,
            'êµ¬ë¶„': cells[2].innerText,
            'ì˜ë¢°ì—…ì²´ëª…': cells[3].innerText,
            'ì‹œë£Œëª…': cells[4].innerText, // ë“œë¡­ë‹¤ìš´ì—ì„œ ì„ íƒëœ ì¢…ëª©ëª…
            'ê³µìˆ˜': cells[5].innerText,   // 1ë‹¨ìœ„ë¡œ ë°”ë€ ê³µìˆ˜
            'ì¶œì¥ë¹„': cells[6].innerText, // ì½¤ë§ˆ í¬í•¨ëœ ê¸ˆì•¡
            'ì¶”ê°€': cells[7].innerText,   // ê³„ì‚°ëœ ì¶”ê°€ê¸ˆì•¡
            'ë¹„ê³ ': cells[8].innerText,   // ì…ë ¥ëœ ë¹„ê³ 
            'ì ‘ìˆ˜ë²ˆí˜¸': cells[9].innerText,
            'ì˜ì—…ë‹´ë‹¹': cells[10].innerText,
            'ì§€ê¸‰ì—¬ë¶€': 'ë¯¸ì§€ê¸‰'
        });
    });

    try {
        const response = await fetch('/api/save-settlement/', { // urls.py ê²½ë¡œì— ë§ê²Œ ìˆ˜ì •
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                // CSRF í† í° í•„ìš” ì‹œ ì¶”ê°€: 'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify(dataToSave)
        });

        const result = await response.json();
        if (result.status === 'success') {
            alert(result.message);
            resetModalFields(); // ëª¨ë“  ì…ë ¥ê°’ê³¼ íšŒìƒ‰ DBê¸°ì¤€ ì¹¸ ì´ˆê¸°í™”
            // ì €ì¥ ì„±ê³µ ì‹œ ëª¨ë‹¬ ë‹«ê¸° í˜¹ì€ ì´ˆê¸°í™”
            bootstrap.Modal.getInstance(document.getElementById('settlementModal')).hide();
        } else {
            alert("ì €ì¥ ì‹¤íŒ¨: " + result.message);
        }
    } catch (error) {
        console.error("Error:", error);
        alert("ì„œë²„ í†µì‹  ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
    }
}
// ëª¨ë‹¬ì´ ì™„ì „íˆ í™”ë©´ì—ì„œ ì‚¬ë¼ì¡Œì„ ë•Œ(hidden) ì‹¤í–‰ë˜ëŠ” ì´ë²¤íŠ¸ë¦¬ìŠ¤ë„ˆ
document.getElementById('settlementModal').addEventListener('hidden.bs.modal', function () {
    // ì´ì „ì— ë§Œë“  ì´ˆê¸°í™” í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•©ë‹ˆë‹¤.
    resetModalFields(); 
    console.log("ëª¨ë‹¬ì´ ë‹«í˜€ì„œ ë°ì´í„°ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.");
});
function openSettlementModal(bizRow, qtRow) {
    // 1. ëª¨ë‹¬ ë‚´ ì…ë ¥ì°½ ì´ˆê¸°í™”
    document.getElementById('m_item_selector').value = ""; 
    document.getElementById('m_travel_fee').value = qtRow.supply_value || 0; // ê¸°ë³¸ ì¶œì¥ë¹„ ì„¸íŒ…
    document.getElementById('m_work_count').value = 1; // ê³µìˆ˜ ê¸°ë³¸ê°’ 1
    document.getElementById('m_memo').value = "";

    // 2. [ì¶”ê°€ ìš”ì²­ ê·œì¹™] ì‹œë£Œìˆ˜ê±° í™•ì¸
    const originalSpecimen = bizRow.specimen || ""; // ë¹„ì¦ˆë©”ì¹´ ì›ë³¸ ì‹œë£Œëª…
    const extraFeeInput = document.getElementById('m_extra_fee');
    
    if (originalSpecimen.includes("*ì‹œë£Œìˆ˜ê±°*")) {
        extraFeeInput.value = 50000; // ë‹¨ì–´ í¬í•¨ ì‹œ 50,000ì› ìë™ ì…ë ¥
    } else {
        extraFeeInput.value = 0;
    }

    // 3. í•˜ë‹¨ í‘œ(settlementTargetList)ì— ì›ë³¸ ë°ì´í„° í•œ ì¤„ ìƒì„± (ì¤‘ìš”!)
    const targetList = document.getElementById('settlementTargetList');
    targetList.innerHTML = ""; // ê¸°ì¡´ ë‚´ìš© ë¹„ìš°ê¸°

    const tr = document.createElement('tr');
    tr.className = 'text-center align-middle';
    
    // ëª¨ë‹¬ì„ ì—´ ë•ŒëŠ” ì›ë³¸ ì‹œë£Œëª…ì„ ê·¸ëŒ€ë¡œ í‘œì‹œí•˜ì—¬ í™•ì¸ ê°€ëŠ¥í•˜ê²Œ í•¨
    tr.innerHTML = `
        <td>${bizRow.date || '-'}</td>
        <td>${qtRow.field_tester || '-'}</td>
        <td>í˜„ì¥ì‹œí—˜</td>
        <td class="text-start">${qtRow.builder || '-'}</td>
        <td class="text-start" id="display_specimen">${originalSpecimen}</td> <td>1</td>
        <td class="text-end">${Number(qtRow.supply_value || 0).toLocaleString()}</td>
        <td class="text-end text-danger">${Number(extraFeeInput.value).toLocaleString()}</td>
        <td></td> <td>${qtRow.receipt_code || '-'}</td>
        <td>${qtRow.sales || '-'}</td>
        <td><span class="badge bg-secondary">ë¯¸ì§€ê¸‰</span></td>
    `;
    
    // ì¶”í›„ 'ì •ì‚°í•˜ê¸°' ë²„íŠ¼ í´ë¦­ ì‹œ ì°¸ì¡°ë¥¼ ìœ„í•´ ì›ë³¸ ì‹œë£Œëª…ì„ ë°ì´í„° ì†ì„±ì— ë³´ê´€
    tr.dataset.originalSpecimen = originalSpecimen;
    targetList.appendChild(tr);

    // 4. ëª¨ë‹¬ í‘œì‹œ
    const modal = new bootstrap.Modal(document.getElementById('settlementModal'));
    modal.show();
}

function highlightMatchedRows(finishedData) {
    // ìƒë‹¨ ë¹„ì¦ˆë©”ì¹´ ë¦¬ìŠ¤íŠ¸ì˜ ëª¨ë“  í–‰ì„ ê°€ì ¸ì˜µë‹ˆë‹¤.
    const upperRows = document.querySelectorAll('#bizMechaList tr'); 

    upperRows.forEach(uRow => {
        const uCells = uRow.cells;
        if (uCells.length < 4) return;

        // 1. ìƒë‹¨ ë‚ ì§œ í˜•ì‹ í†µì¼: ë§ˆì¹¨í‘œ(.)ë¥¼ í•˜ì´í”ˆ(-)ìœ¼ë¡œ ë°”ê¾¸ê³  ê³µë°± ì œê±°
        // "2025.12.01" -> "2025-12-01"
        const uDate = uCells[1].innerText.replace(/\s+/g, '').replace(/\./g, '-').trim(); 
        
        // 2. ìƒë‹¨ ì œëª© (ì—…ì²´ëª…ì´ í¬í•¨ëœ ì „ì²´ í…ìŠ¤íŠ¸)
        const uTitle = uCells[3].innerText.trim(); 

        // 3. í•˜ë‹¨ DB ë°ì´í„°ì™€ í•˜ë‚˜ì”© ëŒ€ì¡°
        const isMatched = finishedData.some(item => {
            // í•˜ë‹¨ ë‚ ì§œ (ì´ë¯¸ "2025-12-01" í˜•ì‹ì¼ í™•ë¥ ì´ ë†’ìŒ)
            const fDate = item.ì‹œí—˜ìˆ˜ê±°ì¼.replace(/\s+/g, '').trim(); 

            // í•˜ë‹¨ ì—…ì²´ëª… ì •ì œ: (ì£¼), ì£¼ì‹íšŒì‚¬ ì œê±° í›„ ê³µë°± ì œê±°
            const cleanCompany = item.ì˜ë¢°ì—…ì²´ëª….replace(/\(ì£¼\)|ì£¼ì‹íšŒì‚¬/g, '').trim();

            // ì¡°ê±´: ë‚ ì§œê°€ ì™„ë²½íˆ ê°™ê³ , ìƒë‹¨ ì œëª© í…ìŠ¤íŠ¸ ì•ˆì— ì •ì œëœ ì—…ì²´ëª…ì´ í¬í•¨ë˜ì–´ ìˆëŠ”ê°€?
            return (uDate === fDate) && (uTitle.includes(cleanCompany));
        });

        // 4. ì¼ì¹˜í•˜ë©´ ë°°ê²½ìƒ‰ ë³€ê²½ (ì—°í•œ ë…¹ìƒ‰)
        if (isMatched) {
            uRow.style.backgroundColor = '#e8f5e9'; // ë°°ê²½: ì—°í•œ ë…¹ìƒ‰
            uRow.style.fontWeight = 'bold';         // ê¸€ì: êµµê²Œ (ì„ íƒ ì‚¬í•­)
        } else {
            uRow.style.backgroundColor = '';         // ë¶ˆì¼ì¹˜ ì‹œ ì›ë˜ëŒ€ë¡œ
            uRow.style.fontWeight = 'normal';
        }
    });
}

// ëª¨ë‹¬ ì°½ ìˆ˜ë™ë³€ê²½
function applyManualChanges() {
    // ìš”ì†Œë“¤ì„ ë³€ìˆ˜ì— í• ë‹¹
    const managerSelect = document.getElementById('m_edit_manager');
    const builderInput = document.getElementById('m_edit_builder');

    const newManager = managerSelect.value;
    const newBuilder = builderInput.value;
    
    // ëª¨ë‹¬ í•˜ë‹¨ í‘œì˜ ì²« ë²ˆì§¸ í–‰ì„ ì°¾ìŠµë‹ˆë‹¤.
    const targetRow = document.querySelector('#settlementTargetList tr');
    
    if (!targetRow) {
        alert("ë¨¼ì € ì •ì‚° ë°ì´í„°ë¥¼ ìƒì„±(ì •ì‚°í•˜ê¸° ë²„íŠ¼ ë“±)í•´ ì£¼ì„¸ìš”.");
        return;
    }

    // 1. í˜„ì¥ë‹´ë‹¹ ì—…ë°ì´íŠ¸ (ê°’ì´ ìˆì„ ë•Œë§Œ ë°˜ì˜)
    if (newManager) {
        targetRow.cells[1].innerText = newManager;
        targetRow.cells[1].style.color = '#0d6efd';
        targetRow.cells[1].style.fontWeight = 'bold';
    }

    // 2. ì˜ë¢°ì—…ì²´ëª… ì—…ë°ì´íŠ¸ (ê°’ì´ ìˆì„ ë•Œë§Œ ë°˜ì˜)
    if (newBuilder) {
        targetRow.cells[3].innerText = newBuilder;
        targetRow.cells[3].style.color = '#0d6efd';
        targetRow.cells[3].style.fontWeight = 'bold';
    }

    // --- [ë¡œì§ ìˆ˜í–‰ í›„ ì…ë ¥ ë„êµ¬ ì´ˆê¸°í™”] ---
    managerSelect.value = ""; // ë“œë¡­ë‹¤ìš´ "ì„ íƒ"ìœ¼ë¡œ ë³µêµ¬
    builderInput.value = "";  // ì—…ì²´ëª… ì…ë ¥ì¹¸ ë¹„ì›€

    console.log("í˜„ì¥ë‹´ë‹¹ ë° ì—…ì²´ëª… ë°˜ì˜ ì™„ë£Œ (ì´ˆê¸°í™” í¬í•¨)");
}
// -----------------ì—¬ê¸°ê¹Œì§€ ì •ì‚°í•˜ê¸° ëª¨ë‹¬ ì°½ ë------------



</script>
</body>
</html>
{% endblock %}