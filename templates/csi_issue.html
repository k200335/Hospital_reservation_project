{% extends "base.html" %}

{% block content %}
<style>
    /* 4등분 고정 레이아웃 */
    .split-wrapper {
        display: grid;
        grid-template-columns: 1fr 1fr;
        grid-template-rows: 1fr 1fr;
        height: calc(100vh - 70px);
        width: 100%;
        gap: 0;
    }

    .panel { 
        overflow: auto; 
        padding: 15px; 
        background: white; 
        border: 1px solid #dee2e6; 
    }
    .panel-bg { background-color: #f8f9fa; }
    .table-custom { font-size: 0.82rem; width: 100%; }
    .sticky-top { position: sticky; top: 0; background: white; z-index: 10; }
</style>

<div class="split-wrapper">
    <div class="panel" id="panel-1">
        <div class="d-flex justify-content-between align-items-center mb-2">
            <h5 class="fw-bold text-primary mb-0">1. CSI 성적서 발급 정보 매칭</h5>
            <div class="d-flex gap-2 align-items-center">
                <input type="date" id="start_date" class="form-control form-control-sm" style="width:130px;" value="{{ default_date }}">
                <span class="fw-bold">~</span>
                <input type="date" id="end_date" class="form-control form-control-sm" style="width:130px;" value="{{ default_date }}">
                <button id="btn-fetch" class="btn btn-sm btn-dark" onclick="fetchCsiIssueList(event)" disabled>조회</button>
                <button id="btn-save" class="btn btn-sm btn-success" onclick="saveMatchingData()" disabled>DB 저장</button>
            </div>
        </div>
        
        <table class="table table-sm table-bordered table-custom">
            <thead class="table-light sticky-top text-center">
                <tr>
                    <th style="width: 40px;"><input type="checkbox" id="check-all"></th>
                    <th>의뢰번호</th> <th>성적서번호</th> <th>봉인명</th> <th>공사명</th>
                    <th>의뢰기관</th> <th>의뢰일자</th> <th>접수일자</th> <th>대기일자</th> <th>발급일자</th>
                </tr>
            </thead>
            <tbody id="csi-matching-body">
                <tr><td colspan="10" class="text-center text-muted">발급일자를 선택하고 조회를 눌러주세요.</td></tr>
            </tbody>
        </table>
    </div>

    <div class="panel" id="panel-2">
        <div class="d-flex justify-content-between align-items-center mb-2">
            <h5 class="fw-bold text-info mb-0">2. CSI 성적서 발급대기 정보 조회</h5>
            <div class="d-flex gap-2 align-items-center">
                <input type="date" id="start_date_2" class="form-control form-control-sm" style="width:130px;" value="{{ default_date }}">
                <span class="fw-bold">~</span>
                <input type="date" id="end_date_2" class="form-control form-control-sm" style="width:130px;" value="{{ default_date }}">
                <button id="btn-fetch-2" class="btn btn-sm btn-dark" onclick="fetchQtData(event)" disabled>조회</button>
                <button id="btn-save-2" class="btn btn-sm btn-info text-white" onclick="saveQtMatchingData()" disabled>DB 저장</button>
            </div>
        </div>
        <table class="table table-sm table-bordered table-custom">
            <thead class="table-light sticky-top text-center">
                <tr>
                    <th style="width: 40px;"><input type="checkbox" id="check-all-2"></th>
                    <th>의뢰번호</th> <th>발급대기일자</th> <th>접수번호</th>
                    <th>봉인명</th> <th>시험·검사 종목</th> <th>공사명</th>
                    <th>접수일자</th> <th>시험·검사진행 확정일자</th> <th>진행상태</th>
                </tr>
            </thead>
            <tbody id="qt-matching-body">
                <tr><td colspan="10" class="text-center text-muted">데이터를 조회해 주세요.</td></tr>
            </tbody>
        </table>
    </div>

    <div class="panel panel-bg">3번 영역 (대기)</div>
    <div class="panel panel-bg">4번 영역 (대기)</div>
</div>

<script>
    /* 체크박스 로직 */
    document.addEventListener('change', function(e) {
        if (e.target.id === 'check-all') {
            document.querySelectorAll('#csi-matching-body .row-check').forEach(cb => cb.checked = e.target.checked);
        }
        if (e.target.id === 'check-all-2') {
            document.querySelectorAll('#qt-matching-body .row-check-2').forEach(cb => cb.checked = e.target.checked);
        }
    });

    /* 1번 영역 데이터 조회 */
    async function fetchCsiIssueList(event) {
        const startDate = document.getElementById('start_date').value;
        const endDate = document.getElementById('end_date').value;
        const tbody = document.getElementById('csi-matching-body');
        const btn = event.target;

        tbody.innerHTML = `<tr><td colspan="10" class="text-center">조회 중...</td></tr>`;
        btn.disabled = true;

        try {
            const response = await fetch("{% url 'fetch_csi_issue_data' %}", {
                method: 'POST',
                headers: {'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}'},
                body: JSON.stringify({ start_date: startDate, end_date: endDate })
            });
            const data = await response.json();
            if (data.status === 'success') {
                tbody.innerHTML = '';
                data.results.forEach(item => {
                    tbody.insertAdjacentHTML('beforeend', `<tr>
                        <td class="text-center"><input type="checkbox" class="row-check"></td>
                        <td><strong>${item.u_id}</strong></td>
                        <td>${item.cert_no}</td><td>${item.seal_name}</td><td>${item.project_name}</td>
                        <td>${item.agency}</td><td>${item.req_date}</td><td>${item.recv_date}</td>
                        <td>${item.wait_date}</td><td>${item.issue_date}</td>
                    </tr>`);
                });
            }
        } catch (e) { alert("에러 발생"); } finally { btn.disabled = false; }
    }

    /* 1번 영역 저장 */
    /** 3. 데이터 저장 및 업데이트 (UPSERT) 함수 **/
async function saveMatchingData() {
    const selectedRows = document.querySelectorAll('.row-check:checked');
    
    if (selectedRows.length === 0) {
        return alert("저장(업데이트)할 항목을 선택해주세요.");
    }

    // 사진의 DB 구조(의뢰번호, 성적서번호, 발급일자)에 맞춰 데이터 추출
    const itemsToSave = Array.from(selectedRows).map(checkbox => {
        const row = checkbox.closest('tr');
        return {
            u_id: row.cells[1].innerText.trim(),       // 의뢰번호
            cert_no: row.cells[2].innerText.trim(),    // 성적서번호
            issue_date: row.cells[9].innerText.trim()  // 발급일자
        };
    });

    if (!confirm(`${itemsToSave.length}건의 데이터를 DB에 반영하시겠습니까?`)) return;

    try {
        const response = await fetch("{% url 'save_csi_matching_data' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({ items: itemsToSave })
        });

        const result = await response.json();
        if (result.status === 'success') {
            alert(result.message);
            document.getElementById('check-all').checked = false;
            selectedRows.forEach(cb => cb.checked = false);
        } else {
            alert("저장 실패: " + result.message);
        }
    } catch (e) {
        alert("서버와 통신 중 에러가 발생했습니다.");
    }
}

    /* 2번 영역 조회 (준비중) */
    /** 2번 영역: CSI 발급대기 정보 수집 (의뢰번호, 대기일자, 접수번호 순서) **/
async function fetchQtData(event) {
    console.log("2번 조회 버튼 클릭됨"); // 작동 확인용 로그
    const tbody = document.getElementById('qt-matching-body');
    const btn = event.target;

    // 1. 로딩 표시 및 버튼 비활성화
    tbody.innerHTML = `<tr><td colspan="10" class="text-center py-4">상세페이지에서 의뢰번호 및 접수번호를 실시간 수집 중입니다...</td></tr>`;
    btn.disabled = true;

    try {
        // 2. 서버로 요청 (body에 날짜 데이터를 담지 않음)
        const response = await fetch("{% url 'fetch_csi_wait_data' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({}) // 빈 객체 전송
        });

        const data = await response.json();

        if (data.status === 'success') {
            tbody.innerHTML = ''; 
            
            if (!data.results || data.results.length === 0) {
                tbody.innerHTML = `<tr><td colspan="10" class="text-center">수집된 데이터가 없습니다.</td></tr>`;
                return;
            }

            // 3. 데이터 렌더링 (의뢰번호 | 발급대기일자 | 접수번호 순서)
            data.results.forEach(item => {
                tbody.insertAdjacentHTML('beforeend', `
                    <tr>
                        <td class="text-center"><input type="checkbox" class="row-check-2"></td>
                        <td class="text-center"><strong class="text-info">${item.u_id}</strong></td> 
                        <td class="text-center text-danger fw-bold">${item.wait_date}</td>      
                        <td class="text-center">${item.receipt_no}</td>                      
                        <td>${item.cert_no}</td>
                        <td>${item.seal_name}</td>
                        <td>${item.project_name}</td>
                        <td>${item.agency}</td>
                        <td class="text-center">${item.req_date}</td>
                        <td class="text-center">${item.recv_date}</td>
                    </tr>
                `);
            });
        } else {
            alert("에러 발생: " + data.message);
            tbody.innerHTML = `<tr><td colspan="10" class="text-center text-danger">오류가 발생했습니다.</td></tr>`;
        }
    } catch (e) {
        console.error(e);
        alert("통신 에러가 발생했습니다.");
    } finally {
        // 4. 버튼 다시 활성화
        btn.disabled = false;
    }
}

    /* 5. 2번 영역: DB 저장 (추가된 기능) */
    function saveQtMatchingData() { alert("2번 영역 데이터 DB 저장 기능 실행"); }

    /* 권한 제어 */
document.addEventListener("DOMContentLoaded", function() {
    // 1. 서버에서 사용자 ID 가져오기
    const currentUserId = "{{ request.user.username }}"; 
    
    // 2. 허용할 아이디 리스트
    const allowedIds = ["admin_work", "admin_home"]; 

    // 모든 버튼을 하나의 배열로 관리합니다.
    const allBtns = [
        document.getElementById('btn-fetch'),   // 1번 조회
        document.getElementById('btn-save'),    // 1번 저장
        document.getElementById('btn-fetch-2'), // 2번 조회
        document.getElementById('btn-save-2')   // 2번 저장
    ];

    // 3. 권한 체크 로직
    if (allowedIds.includes(currentUserId)) {
        // [권한 있음] 모든 버튼 활성화
        allBtns.forEach(btn => {
            if (btn) {
                btn.removeAttribute('disabled');
                btn.disabled = false; // 확실히 하기 위해 명시적 처리
                btn.style.opacity = "1";
                btn.style.cursor = "pointer";
            }
        });
        console.log("관리자 권한 확인됨: " + currentUserId);
    } else {
        // [권한 없음] 모든 버튼 비활성화 및 시각적 피드백
        allBtns.forEach(btn => {
            if (btn) {
                btn.disabled = true;
                btn.style.opacity = "0.5";
                btn.style.cursor = "not-allowed";
                btn.title = "권한이 없습니다.";
                
                // 클릭 시 알림 (이미 disabled면 안 눌리지만 이중 잠금)
                btn.onclick = function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    alert("해당 기능을 사용할 권한이 없습니다.");
                    return false;
                };
            }
        });
        console.log("권한 없음: " + currentUserId);
    }
});
</script>
{% endblock %}

