{% extends "base.html" %}
{% block content %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
    /* 4등분 고정 레이아웃 */
    .split-wrapper {
        display: grid;
        grid-template-columns: 1fr 1fr;
        grid-template-rows: 1fr 1fr;
        height: calc(100vh - 70px);
        width: 100%;
        gap: 0;
    }

    .panel { 
        overflow: auto; 
        padding: 15px; 
        background: white; 
        border: 1px solid #dee2e6; 
    }
    .panel-bg { background-color: #f8f9fa; }
    .table-custom { font-size: 0.82rem; width: 100%; }
    .sticky-top { position: sticky; top: 0; background: white; z-index: 10; }
</style>

<div class="split-wrapper">
    <div class="panel" id="panel-1">
        <div class="d-flex justify-content-between align-items-center mb-2">
            <h5 class="fw-bold text-primary mb-0">1. CSI 성적서 발급 정보 매칭</h5>
            <div class="d-flex gap-2 align-items-center">
                <input type="date" id="start_date" class="form-control form-control-sm" style="width:130px;" value="{{ default_date }}">
                <span class="fw-bold">~</span>
                <input type="date" id="end_date" class="form-control form-control-sm" style="width:130px;" value="{{ default_date }}">
                <button id="btn-fetch" class="btn btn-sm btn-dark" onclick="fetchCsiIssueList(event)" disabled>조회</button>
                <button id="btn-save" class="btn btn-sm btn-success" onclick="saveMatchingData()" disabled>DB 저장</button>
            </div>
        </div>
        
        <table class="table table-sm table-bordered table-custom">
            <thead class="table-light sticky-top text-center">
                <tr>
                    <th style="width: 40px;"><input type="checkbox" id="check-all"></th>
                    <th>의뢰번호</th> <th>성적서번호</th> <th>봉인명</th> <th>공사명</th>
                    <th>의뢰기관</th> <th>의뢰일자</th> <th>접수일자</th> <th>대기일자</th> <th>발급일자</th>
                </tr>
            </thead>
            <tbody id="csi-matching-body">
                <tr><td colspan="10" class="text-center text-muted">발급일자를 선택하고 조회를 눌러주세요.</td></tr>
            </tbody>
        </table>
    </div>

    <div class="panel" id="panel-2">
        <div class="d-flex justify-content-between align-items-center mb-2">
            <h5 class="fw-bold text-info mb-0">2. CSI 성적서 발급대기 정보 조회</h5>
            <div class="d-flex gap-2 align-items-center">
                <button id="btn-fetch-2" class="btn btn-sm btn-dark" onclick="fetchQtData(event)" disabled>조회</button>
                
                <button id="btn-save-2" class="btn btn-sm btn-info text-white" onclick="saveQtData()" disabled>DB 저장</button>
                
                <button id="btn-excel-download-2" class="btn btn-sm btn-success" onclick="downloadExcel2()" disabled>엑셀 다운로드</button>
                
                <button id="btn-excel-upload-2" class="btn btn-sm btn-warning text-white" onclick="triggerExcelUpload2()" disabled>엑셀 가져오기</button>
                
                <input type="file" id="excel_file_2" style="display:none;" onchange="uploadExcel2(event)" accept=".xlsx, .xls">
            </div>
        </div>
        <table class="table table-sm table-bordered table-custom">
            <thead class="table-light sticky-top text-center">
                <tr>
                    <th style="width: 40px;"><input type="checkbox" id="check-all-2"></th>
                    <th>의뢰번호</th> <th>발급대기일자</th> <th>접수번호</th>
                    <th>봉인명</th> <th>시험·검사 종목</th> <th>공사명</th>
                    <th>접수일자</th> <th>시험·검사진행 확정일자</th> <th>진행상태</th>
                </tr>
            </thead>
            <tbody id="qt-matching-body">
                <tr><td colspan="10" class="text-center text-muted">데이터를 조회해 주세요.</td></tr>
            </tbody>
        </table>
    </div>

    <div class="panel panel-bg">3번 영역 (대기)</div>
    <div class="panel panel-bg">4번 영역 (대기)</div>
</div>

<script>
    /* 체크박스 로직 */
    document.addEventListener('change', function(e) {
        if (e.target.id === 'check-all') {
            document.querySelectorAll('#csi-matching-body .row-check').forEach(cb => cb.checked = e.target.checked);
        }
        if (e.target.id === 'check-all-2') {
            document.querySelectorAll('#qt-matching-body .row-check-2').forEach(cb => cb.checked = e.target.checked);
        }
    });

    /* 1번 영역 데이터 조회 */
    async function fetchCsiIssueList(event) {
        const startDate = document.getElementById('start_date').value;
        const endDate = document.getElementById('end_date').value;
        const tbody = document.getElementById('csi-matching-body');
        const btn = event.target;

        tbody.innerHTML = `<tr><td colspan="10" class="text-center">조회 중...</td></tr>`;
        btn.disabled = true;

        try {
            const response = await fetch("{% url 'fetch_csi_issue_data' %}", {
                method: 'POST',
                headers: {'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}'},
                body: JSON.stringify({ start_date: startDate, end_date: endDate })
            });
            const data = await response.json();
            if (data.status === 'success') {
                tbody.innerHTML = '';
                data.results.forEach(item => {
                    tbody.insertAdjacentHTML('beforeend', `<tr>
                        <td class="text-center"><input type="checkbox" class="row-check"></td>
                        <td><strong>${item.u_id}</strong></td>
                        <td>${item.cert_no}</td><td>${item.seal_name}</td><td>${item.project_name}</td>
                        <td>${item.agency}</td><td>${item.req_date}</td><td>${item.recv_date}</td>
                        <td>${item.wait_date}</td><td>${item.issue_date}</td>
                    </tr>`);
                });
            }
        } catch (e) { alert("에러 발생"); } finally { btn.disabled = false; }
    }

    /* 1번 영역 저장 */
    /** 3. 데이터 저장 및 업데이트 (UPSERT) 함수 **/
async function saveMatchingData() {
    const selectedRows = document.querySelectorAll('.row-check:checked');
    
    if (selectedRows.length === 0) {
        return alert("저장(업데이트)할 항목을 선택해주세요.");
    }

    // 사진의 DB 구조(의뢰번호, 성적서번호, 발급일자)에 맞춰 데이터 추출
    const itemsToSave = Array.from(selectedRows).map(checkbox => {
        const row = checkbox.closest('tr');
        return {
            u_id: row.cells[1].innerText.trim(),       // 의뢰번호
            cert_no: row.cells[2].innerText.trim(),    // 성적서번호
            issue_date: row.cells[9].innerText.trim()  // 발급일자
        };
    });

    if (!confirm(`${itemsToSave.length}건의 데이터를 DB에 반영하시겠습니까?`)) return;

    try {
        const response = await fetch("{% url 'save_csi_matching_data' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({ items: itemsToSave })
        });

        const result = await response.json();
        if (result.status === 'success') {
            alert(result.message);
            document.getElementById('check-all').checked = false;
            selectedRows.forEach(cb => cb.checked = false);
        } else {
            alert("저장 실패: " + result.message);
        }
    } catch (e) {
        alert("서버와 통신 중 에러가 발생했습니다.");
    }
}

    /* 2번 영역 조회 (준비중) */
    /** 2번 영역: CSI 발급대기 정보 수집 (의뢰번호, 대기일자, 접수번호 순서) **/
async function fetchQtData(event) {
    console.log("2번 조회 버튼 클릭됨"); // 작동 확인용 로그
    const tbody = document.getElementById('qt-matching-body');
    const btn = event.target;

    // 1. 로딩 표시 및 버튼 비활성화
    tbody.innerHTML = `<tr><td colspan="10" class="text-center py-4">상세페이지에서 의뢰번호 및 접수번호를 실시간 수집 중입니다...</td></tr>`;
    btn.disabled = true;

    try {
        // 2. 서버로 요청 (body에 날짜 데이터를 담지 않음)
        const response = await fetch("{% url 'fetch_csi_wait_data' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({}) // 빈 객체 전송
        });

        const data = await response.json();

        if (data.status === 'success') {
            tbody.innerHTML = ''; 
            
            if (!data.results || data.results.length === 0) {
                tbody.innerHTML = `<tr><td colspan="10" class="text-center">수집된 데이터가 없습니다.</td></tr>`;
                return;
            }

            // 3. 데이터 렌더링 (의뢰번호 | 발급대기일자 | 접수번호 순서)
            data.results.forEach(item => {
                tbody.insertAdjacentHTML('beforeend', `
                    <tr>
                        <td class="text-center"><input type="checkbox" class="row-check-2"></td>
                        <td class="text-center"><strong class="text-info">${item.u_id}</strong></td> 
                        <td class="text-center text-danger fw-bold">${item.wait_date}</td>      
                        <td class="text-center">${item.receipt_no}</td>                      
                        <td>${item.cert_no}</td>
                        <td>${item.seal_name}</td>
                        <td>${item.project_name}</td>
                        <td>${item.agency}</td>
                        <td class="text-center">${item.req_date}</td>
                        <td class="text-center">${item.recv_date}</td>
                    </tr>
                `);
            });
        } else {
            alert("에러 발생: " + data.message);
            tbody.innerHTML = `<tr><td colspan="10" class="text-center text-danger">오류가 발생했습니다.</td></tr>`;
        }
    } catch (e) {
        console.error(e);
        alert("통신 에러가 발생했습니다.");
    } finally {
        // 4. 버튼 다시 활성화
        btn.disabled = false;
    }
}

    /* 5. 2번 영역: DB 저장 (추가된 기능) */
    async function saveQtData() {
    // 1. 2번 영역 전용 체크박스 클래스(.row-check-2)로 선택된 행 가져오기
    const selectedRows = document.querySelectorAll('.row-check-2:checked');
    
    if (selectedRows.length === 0) {
        return alert("저장(업데이트)할 항목을 선택해주세요.");
    }

    // 2. 2번 테이블 순서에 맞춰 데이터 추출
    // 순서: 체크박스(0) | 의뢰번호(1) | 발급대기일자(2) | 접수번호(3) ...
    const itemsToSave = Array.from(selectedRows).map(checkbox => {
        const row = checkbox.closest('tr');
        return {
            u_id: row.cells[1].innerText.trim(),       // 의뢰번호
            wait_date: row.cells[2].innerText.trim(),  // 발급대기일자 -> 파이썬의 '발급일자' 컬럼으로 감
            // receipt_no: row.cells[3].innerText.trim()  // 접수번호 (필요시 DB 확장 대비)
        };
    });

    if (!confirm(`${itemsToSave.length}건의 데이터를 DB에 반영하시겠습니까?\n(성적서번호는 '승인전'으로 업데이트됩니다.)`)) return;

    try {
        // 3. 2번 전용 저장 URL 호출
        const response = await fetch("{% url 'save_csi_wait_data' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({ items: itemsToSave })
        });

        const result = await response.json();
        if (result.status === 'success') {
            alert(result.message);
            // 전체 선택 체크박스 해제 (2번 영역용 ID가 있다면 그것으로 변경)
            const checkAll2 = document.getElementById('check-all-2');
            if (checkAll2) checkAll2.checked = false;
            selectedRows.forEach(cb => cb.checked = false);
        } else {
            alert("저장 실패: " + result.message);
        }
    } catch (e) {
        console.error(e);
        alert("서버와 통신 중 에러가 발생했습니다.");
    }
}

    /* 권한 제어 */
document.addEventListener("DOMContentLoaded", function() {
    // 1. 서버에서 사용자 ID 가져오기
    const currentUserId = "{{ request.user.username }}"; 
    
    // 2. 허용할 아이디 리스트
    const allowedIds = ["admin_work", "admin_home"]; 

    // 모든 버튼을 하나의 배열로 관리합니다.
    const allBtns = [
        document.getElementById('btn-fetch'),   // 1번 조회
        document.getElementById('btn-save'),    // 1번 저장
        document.getElementById('btn-fetch-2'), // 2번 조회
        document.getElementById('btn-save-2'),   // 2번 저장
        document.getElementById('btn-excel-download-2'), // 추가
        document.getElementById('btn-excel-upload-2')    // 추가
    ];

    // 3. 권한 체크 로직
    if (allowedIds.includes(currentUserId)) {
        // [권한 있음] 모든 버튼 활성화
        allBtns.forEach(btn => {
            if (btn) {
                btn.removeAttribute('disabled');
                btn.disabled = false; // 확실히 하기 위해 명시적 처리
                btn.style.opacity = "1";
                btn.style.cursor = "pointer";
            }
        });
        console.log("관리자 권한 확인됨: " + currentUserId);
    } else {
        // [권한 없음] 모든 버튼 비활성화 및 시각적 피드백
        allBtns.forEach(btn => {
            if (btn) {
                btn.disabled = true;
                btn.style.opacity = "0.5";
                btn.style.cursor = "not-allowed";
                btn.title = "권한이 없습니다.";
                
                // 클릭 시 알림 (이미 disabled면 안 눌리지만 이중 잠금)
                btn.onclick = function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    alert("해당 기능을 사용할 권한이 없습니다.");
                    return false;
                };
            }
        });
        console.log("권한 없음: " + currentUserId);
    }
});

/** 2번 영역: 표 데이터를 엑셀로 다운로드 **/
function downloadExcel2() {
    const tbody = document.getElementById('qt-matching-body');
    const rows = tbody.querySelectorAll('tr');
    
    // 데이터가 없는 경우 체크
    if (rows.length === 0 || rows[0].innerText.includes("조회된 데이터가 없습니다")) {
        return alert("다운로드할 데이터가 없습니다.");
    }

    // 1. 엑셀에 들어갈 헤더 정의 (사용자님이 바꾼 순서 기준)
    const data = [
        ["의뢰번호", "발급대기일자", "접수번호", "봉인명", "시험·검사 종목", "공사명", "접수일자", "시험·검사진행 확정일자", "진행상태"]
    ];

    // 2. 표의 각 행을 돌면서 데이터 추출
    rows.forEach(row => {
        const cells = row.cells;
        data.push([
            cells[1].innerText.trim(), // 의뢰번호
            cells[2].innerText.trim(), // 발급대기일자
            cells[3].innerText.trim(), // 접수번호
            cells[4].innerText.trim(), // 봉인명
            cells[5].innerText.trim(), // 시험·검사 종목
            cells[6].innerText.trim(), // 공사명
            cells[7].innerText.trim(), // 접수일자
            cells[8].innerText.trim(), // 시험·검사진행 확정일자
            cells[9].innerText.trim()  // 진행상태
        ]);
    });

    // 3. 엑셀 워크북 생성 및 파일 저장
    const worksheet = XLSX.utils.aoa_to_sheet(data);
    const workbook = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(workbook, worksheet, "발급대기목록");

    // 파일명에 오늘 날짜 포함 (예: CSI_발급대기_20260107.xlsx)
    const today = new Date().toISOString().slice(0, 10).replace(/-/g, '');
    XLSX.writeFile(workbook, `CSI_발급대기_${today}.xlsx`);
}

/** 2번 영역: 엑셀 파일 읽어서 표에 표시 **/
function uploadExcel2(event) {
    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function(e) {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: 'array' });
        
        // 첫 번째 시트 가져오기
        const sheetName = workbook.SheetNames[0];
        const worksheet = workbook.Sheets[sheetName];
        
        // 시트 데이터를 JSON 배열로 변환 (헤더 제외하고 데이터만)
        const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
        
        if (jsonData.length <= 1) {
            alert("엑셀 파일에 데이터가 없습니다.");
            return;
        }

        const tbody = document.getElementById('qt-matching-body');
        tbody.innerHTML = ''; // 기존 표 내용 초기화

        // 첫 번째 행은 헤더이므로 i=1부터 시작
        for (let i = 1; i < jsonData.length; i++) {
            const rowData = jsonData[i];
            if (rowData.length === 0) continue;

            // 엑셀 컬럼 순서가 저장할 때와 동일하다고 가정 (의뢰번호, 대기일자, 접수번호...)
            // 엑셀 순서: 0:의뢰번호, 1:발급대기일자, 2:접수번호, 3:성적서번호, 4:봉인명, 5:공사명, 6:의뢰기관, 7:의뢰일자, 8:접수일자
            const htmlRow = `
                <tr>
                    <td class="text-center"><input type="checkbox" class="row-check-2"></td>
                    <td class="text-center"><strong>${rowData[0] || ''}</strong></td>
                    <td class="text-center">${rowData[1] || ''}</td>
                    <td class="text-center">${rowData[2] || ''}</td>
                    <td>${rowData[3] || ''}</td>
                    <td>${rowData[4] || ''}</td>
                    <td>${rowData[5] || ''}</td>
                    <td>${rowData[6] || ''}</td>
                    <td class="text-center">${rowData[7] || ''}</td>
                    <td class="text-center">${rowData[8] || ''}</td>
                </tr>
            `;
            tbody.insertAdjacentHTML('beforeend', htmlRow);
        }
        
        alert(`${jsonData.length - 1}건의 데이터를 엑셀에서 불러왔습니다.`);
        // 파일 input 초기화 (같은 파일 다시 올릴 수 있도록)
        event.target.value = '';
    };
    reader.readAsArrayBuffer(file);
}

/** 숨겨진 파일 선택창 클릭 트리거 **/
function triggerExcelUpload2() {
    document.getElementById('excel_file_2').click();
}
</script>
{% endblock %}

